---
import { Icon } from "astro-icon/components";
import { SITE_THEME } from "@config";
---

<div class="dropdown dropdown-end">
  <div tabindex="0" role="button" class="btn btn-ghost btn-circle btn-sm hover:bg-transparent text-primary" title="Settings">
    <Icon name="feather:settings" class="w-6 h-6" />
  </div>
  <ul tabindex="0" class="dropdown-content z-[100] menu p-2 shadow-2xl bg-base-200 rounded-box w-64 mt-4">
    <!-- Dark/Light Toggle -->
    <li>
      <button id="mobile-theme-toggle" class="flex justify-between items-center gap-2 p-2 hover:bg-base-300 rounded-lg w-full">
        <span class="font-medium">Dark/Light</span>
        <div class="btn btn-ghost btn-circle btn-sm text-primary hover:bg-primary/10 hover:scale-110 transition-all duration-300 pointer-events-none flex items-center justify-center">
          <Icon name="feather:sun" class="w-5 h-5 light-icon" />
          <Icon name="feather:moon" class="w-5 h-5 dark-icon hidden" />
        </div>
      </button>
    </li>
  </ul>
</div>

<script is:inline define:vars={{ SITE_THEME }}>
  document.addEventListener("astro:page-load", () => {
    // Dark/Light Toggle Logic
    const mobileThemeToggle = document.getElementById("mobile-theme-toggle");
    
    const updateMobileThemeIcons = (isDark) => {
      if (!mobileThemeToggle) return;
      const lightIcon = mobileThemeToggle.querySelector(".light-icon");
      const darkIcon = mobileThemeToggle.querySelector(".dark-icon");
      
      if (lightIcon && darkIcon) {
        if (isDark) {
          lightIcon.classList.add("hidden");
          darkIcon.classList.remove("hidden");
        } else {
          lightIcon.classList.remove("hidden");
          darkIcon.classList.add("hidden");
        }
      }
    };

    // Initialize icon state
    const currentTheme = document.documentElement.getAttribute("data-theme");
    updateMobileThemeIcons(currentTheme === SITE_THEME.dark);

    if (mobileThemeToggle) {
      mobileThemeToggle.addEventListener("click", () => {
        const currentTheme = document.documentElement.getAttribute("data-theme");
        const newTheme = currentTheme === SITE_THEME.light ? SITE_THEME.dark : SITE_THEME.light;
        
        document.documentElement.setAttribute("data-theme", newTheme);
        const themeType = newTheme === SITE_THEME.dark ? "dark" : "light";
        document.documentElement.setAttribute("data-theme-type", themeType);
        localStorage.setItem("theme", newTheme);
        
        updateMobileThemeIcons(newTheme === SITE_THEME.dark);
        
        // Sync with other toggles if any
        const allToggles = document.querySelectorAll("[data-theme-toggle]");
        allToggles.forEach(() => {
           // Assuming other toggles have similar structure or logic, 
           // but since we are in mobile settings, we might be the only one active or visible.
           // If needed, dispatch a custom event or manually update them.
           // For now, just updating the DOM attribute is enough for styles, 
           // but icons on other toggles might need refresh if they are visible.
        });
      });
    }
  });
</script>