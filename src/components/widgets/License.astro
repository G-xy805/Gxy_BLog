---  
import dayjs from "@utils/dayjs";  
import { USER_NAME, DATE_FORMAT, t, umamiConfig } from "@config";  
import type { PostData } from "@interfaces/data";  
import { Icon } from "astro-icon/components";  
import PostFilter from "./PostFilter.astro";  
  
const { title, url, pubDate, badge, categories = [], tags = [], word, time } = Astro.props as PostData;  
const displayDate = pubDate ? dayjs(pubDate).format(DATE_FORMAT) : "";  
  
// ä» URL ä¸­æå– slug  
const slug = url ? url.toString().split('/').filter(Boolean).pop() : undefined;  
  
const socialLinks = [
  {
    name: "å¾®åš",
    icon: "ri:weibo-line",
    class: "bg-[#E6162D] hover:bg-[#c5122a]",
    url: `https://service.weibo.com/share/share.php?title=${title}&url=${url}`,
  },
  {
    name: "QQ",
    icon: "ri:qq-line",
    class: "bg-[#12B7F5] hover:bg-[#0b9ed8]",
    url: `https://connect.qq.com/widget/shareqq/index.html?title=${title}&url=${url}`,
  },
  {
    name: "å¾®ä¿¡",
    icon: "ri:wechat-line",
    class: "bg-[#07C160] hover:bg-[#06ad57]",
  },
];

---  
  
<hr />  
<div class="container p-0">  
  <div class="text-right text-sm text-base-content/60 italic mb-2">  
    <Icon name="feather:heart" class="w-4 h-4 inline-block align-text-bottom text-error" /> Thanks for reading!  
  </div>  
  
  <div class="card bg-base-200 overflow-visible">  
    <div class="card-body relative p-4 sm:p-6 lg:p-8">  
      <!-- License Icon -->  
      <div class="absolute -top-8 left-8">  
        <div class="w-16 h-16 bg-primary rounded-full flex items-center justify-center shadow-lg">  
          <Icon name="ri:creative-commons-line" class="w-10 h-10 text-primary-content" />  
        </div>  
      </div>  
  
      <!-- Article Metadata -->  
      <div class="space-y-4">  
        <h3 class="text-lg sm:text-xl lg:text-2xl font-bold">{title}</h3>  
  
        <!-- Stats Row -->
        <div class="flex flex-wrap justify-start items-center gap-2 sm:gap-4 text-xs sm:text-sm opacity-75">
          <div class="flex flex-wrap gap-2 sm:gap-4">
            {
              displayDate && (
                <span>
                  {displayDate}
                </span>
              )
            }

            {
              badge && (
                <span>
                  {badge}
                </span>
              )
            }
          </div>

          {
            word && time && (
              <div>
                {word} {t("label.wordCount")} Â· {time} {t("label.readTime")}
              </div>
            )
          }  
  
          <!-- æ·»åŠ æµè§ˆé‡æ˜¾ç¤º -->
          {
            slug && umamiConfig.enable && (
              <div>
                <span id="license-page-views">åŠ è½½ä¸­...</span>
              </div>
            )
          }   
        </div>  
  
        <!-- Categories and Tags -->
        <div class="mt-4">
          <div class="hidden sm:flex">
            <PostFilter categories={categories} tags={tags} />
          </div>  
          <!-- License Info -->  
          <hr class="my-4" />  
          <div class="flex justify-between items-center flex-wrap gap-4">  
            <div class="text-sm opacity-75">  
              Â© {USER_NAME} |  
              <a  
                href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed"  
                target="_blank"  
                rel="noopener noreferrer"  
                class="hover:text-primary transition-colors"  
              >  
                CC BY-NC-SA 4.0  
              </a>  
            </div>  
            <div class="flex gap-2">
              <!-- Support Button -->
              <button id="donate_button" class="btn btn-accent text-white" onmouseenter="reward_modal.showModal()">
                æ‰“èµä½œè€…
              </button>
              
              <button class="btn btn-primary btn-outline" onclick="share_modal.showModal()">  
                {t("label.share")}  
                <Icon name="feather:share-2" class="w-5 h-5" />  
              </button>  
            </div>  
          </div>  
        </div>  
      </div>  
    </div>  
  </div>  
  
  <!-- Share Modal -->  
  <dialog id="share_modal" class="modal modal-bottom sm:modal-middle">  
    <div class="modal-box max-w-2xl rounded-none sm:rounded-xl relative">  
      <h3 class="font-bold text-lg sm:text-xl mb-6 text-center">  
        {t("label.shareCard")}  
      </h3>  
      <div class="flex flex-wrap gap-4 justify-center">  
        {  
          socialLinks.map(({ name, icon, class: bgClass, url }) => {  
            if (name === "å¾®ä¿¡") {  
              return (  
                <button  
                  class={`btn btn-circle btn-lg transition-transform hover:scale-110 ${bgClass}`}  
                  title={name}  
                  onclick="wechat_qr_modal.showModal()"  
                >  
                  <span class="sr-only">{name}</span>  
                  <Icon name={icon} class="w-6 h-6 text-white" />  
                </button>  
              );  
            }  
            return (  
              <a  
                href={url}  
                class={`btn btn-circle btn-lg transition-transform hover:scale-110 ${bgClass}`}  
                target="_blank"  
                rel="noopener noreferrer"  
                title={name}  
              >  
                <span class="sr-only">{name}</span>  
                <Icon name={icon} class="w-6 h-6 text-white" />  
              </a>  
            );  
          })  
        }
        <!-- å¤åˆ¶é“¾æ¥ Button -->
        <button
          class="btn btn-circle btn-lg transition-transform hover:scale-110 bg-neutral hover:bg-neutral-focus"
          title="å¤åˆ¶é“¾æ¥"
          onclick={`navigator.clipboard.writeText(window.location.href).then(() => {
            const btn = this;
            const toast = document.getElementById('copy-toast');
            btn.classList.add('btn-success');
            if (toast) {
              toast.classList.remove('opacity-0', 'translate-y-4');
            }
            setTimeout(() => {
              btn.classList.remove('btn-success');
              if (toast) {
                toast.classList.add('opacity-0', 'translate-y-4');
              }
            }, 2000);
          })`}
        >
          <span class="sr-only">å¤åˆ¶é“¾æ¥</span>
          <Icon name="feather:link-2" class="w-6 h-6 text-white" />
        </button>
      </div>

      <!-- Toast Notification inside Modal -->
      <div id="copy-toast" class="absolute left-1/2 -translate-x-1/2 bottom-20 transition-all duration-300 opacity-0 translate-y-4 pointer-events-none z-50 w-max">
        <div class="alert alert-success shadow-lg text-white py-2 px-4 text-sm">
          <Icon name="feather:check-circle" class="w-5 h-5" />
          <span>é“¾æ¥å·²å¤åˆ¶æˆåŠŸï¼</span>
        </div>
      </div>

      <div class="modal-action">  
        <form method="dialog">  
          <button class="btn btn-ghost hover:scale-105 transition-transform">  
            {t("label.close")}  
          </button>  
        </form>  
      </div>  
    </div>  
    <form method="dialog" class="modal-backdrop">  
      <button>{t("label.close")}</button>  
    </form>  
  </dialog>

  <!-- WeChat QR Code Modal -->
  <dialog id="wechat_qr_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box w-full sm:max-w-lg rounded-none sm:rounded-xl p-6 bg-white">
      <div class="text-center">
        <div class="mb-4 text-green-500">
          <Icon name="ri:wechat-fill" class="w-12 h-12 mx-auto" />
        </div>
        <div class="bg-white rounded-lg shadow-lg mb-4 mx-auto p-4" style="display: flex; justify-content: center; align-items: center; width: 204px; height: 204px;">
          <img
            src={`https://api.qrserver.com/v1/create-qr-code/?size=196x196&margin=4&data=${encodeURIComponent(url || '')}`}
            alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç "
            class="max-w-full h-auto"
          />
        </div>
        <p class="text-lg text-black dark:text-white break-words">æ‰‹æœºå¾®ä¿¡æ‰«æäºŒç»´ç ï¼Œç‚¹å‡»å³ä¸Šè§’Â·Â·Â·æŒ‰é’®åˆ†äº«</p>
      </div>
      <div class="modal-action">
        <form method="dialog">
          <button class="btn btn-ghost hover:scale-105 transition-transform">
            {t("label.close")}
          </button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>{t("label.close")}</button>
    </form>
  </dialog>

  <!-- Reward Modal -->
  <dialog id="reward_modal" class="modal modal-bottom sm:modal-middle" data-pagefind-ignore>
    <div class="modal-box max-w-md rounded-none sm:rounded-xl p-4">
      <h3 class="font-bold text-lg sm:text-xl mb-2 text-center">
        ğŸ‰ æ„Ÿè°¢ä½ çš„æ”¯æŒï¼
      </h3>
      <div class="flex justify-center mb-0">
        <img src="/donate.webp" alt="æ‰“èµäºŒç»´ç " class="max-w-[90%] max-h-[250px] h-auto rounded-lg object-contain" />
      </div>
      <div class="modal-action mt-2">
        <form method="dialog">
          <button class="btn btn-ghost hover:scale-105 transition-transform">
            {t("label.close")}
          </button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>{t("label.close")}</button>
    </form>
  </dialog>
</div>  
  
{slug && umamiConfig.enable && (
  <script define:vars={{ slug, umamiConfig }} is:inline>  
    // è·å–æµè§ˆé‡ç»Ÿè®¡  
    async function fetchLicensePageViews() {  
      if (!umamiConfig.enable) {  
        return;  
      }  
        
      try {  
        // ç¬¬ä¸€æ­¥ï¼šè·å–ç½‘ç«™IDå’Œtoken  
        const shareResponse = await fetch(`${umamiConfig.baseUrl}/api/share/${umamiConfig.shareId}`);  
        if (!shareResponse.ok) {  
          throw new Error('è·å–åˆ†äº«ä¿¡æ¯å¤±è´¥');  
        }  
        const shareData = await shareResponse.json();  
        const { websiteId, token } = shareData;  
          
        // ç¬¬äºŒæ­¥ï¼šè·å–ç»Ÿè®¡æ•°æ®  
        const currentTimestamp = Date.now();  
        const statsUrl = `${umamiConfig.baseUrl}/api/websites/${websiteId}/stats?startAt=0&endAt=${currentTimestamp}&unit=hour&timezone=${encodeURIComponent(umamiConfig.timezone)}&url=%2Fblog%2F${slug}&compare=false`;  
          
        const statsResponse = await fetch(statsUrl, {  
          headers: {  
            'x-umami-share-token': token  
          }  
        });  
          
        if (!statsResponse.ok) {  
          throw new Error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥');  
        }  
          
        const statsData = await statsResponse.json();  
        const pageViews = statsData.pageviews?.value || 0;  
        const visits = statsData.visits?.value || 0;  
          
        const displayElement = document.getElementById('license-page-views');  
        if (displayElement) {  
          displayElement.textContent = `æµè§ˆé‡ ${pageViews} Â· è®¿é—®æ•° ${visits}`;  
        }  
      } catch (error) {  
        console.error('Error fetching page views for license:', error);  
        const displayElement = document.getElementById('license-page-views');  
        if (displayElement) {  
          displayElement.textContent = 'ç»Ÿè®¡ä¸å¯ç”¨';  
        }  
      }  
    }  
  
    // é¡µé¢åŠ è½½å®Œæˆåè·å–ç»Ÿè®¡æ•°æ®  
    if (document.readyState === 'loading') {  
      document.addEventListener('DOMContentLoaded', fetchLicensePageViews);  
    } else {  
      fetchLicensePageViews();  
    }  
  </script>  
)}  
  
<style>  
  .modal-backdrop button {  
    cursor: default;  
    width: 100%;  
    height: 100%;  
    opacity: 0;  
  }  
  
  /* Remove underlines from PostFilter buttons */  
  :global(.card-body .btn-category),  
  :global(.card-body .btn-tag) {  
    text-decoration: none;  
  }  
</style>