---
// 可靠的图标组件
// 提供加载状态管理和错误处理
import { getIcon, iconColors, iconSizes } from "@/config/iconConfig";

export interface Props {
	icon?: string; // 直接图标名称
	category?: string; // 图标分类
	name?: string; // 图标名称
	class?: string;
	style?: string;
	size?:
		| "xs"
		| "sm"
		| "md"
		| "lg"
		| "xl"
		| "2xl"
		| "2xl-md"
		| "3xl"
		| "4xl"
		| "5xl";
	color?: string;
	colorType?: keyof typeof iconColors; // 颜色类型
	fallback?: string; // 备用图标或文本
	loading?: "lazy" | "eager";
}

const {
	icon: directIcon,
	category,
	name,
	class: className = "",
	style = "",
	size = "md",
	color,
	colorType,
	fallback = "●",
	loading = "lazy",
} = Astro.props;

// 获取图标
let icon = directIcon;
if (category && name) {
	icon = getIcon(category, name);
}

// 尺寸映射
const sizeClass = iconSizes[size] || iconSizes.md;

// 颜色处理
let colorClass = "";
if (colorType && iconColors[colorType]) {
	colorClass = iconColors[colorType];
}

const colorStyle = color ? `color: ${color};` : "";
const combinedStyle = `${colorStyle}${style}`;
// 如果传入了自定义 class，则优先使用自定义 class，否则使用 sizeClass
const combinedClass = className
	? `${className} ${colorClass}`.trim()
	: `${sizeClass} ${colorClass}`.trim();

// 生成唯一ID
const iconId = `icon-${Math.random().toString(36).slice(2, 11)}`;
---

<span 
  class={`inline-flex items-center justify-center ${combinedClass}`}
  style={combinedStyle}
  data-icon-container={iconId}
>
  <!-- 加载状态指示器 -->
  <span 
    class="icon-loading animate-pulse opacity-50"
    data-loading-indicator
  >
    {fallback}
  </span>
  
  <!-- 实际图标 -->
  <iconify-icon 
    icon={icon}
    class="icon-content opacity-0 transition-opacity duration-200"
    style="color: currentColor; width: 100%; height: 100%; display: inline-flex; --iconify-icon-padding: 0;"
    width="100%"
    height="100%"
    data-icon-element
    loading={loading}
  ></iconify-icon>
</span>

<style>
  .icon-loading {
    min-width: 1em;
    min-height: 1em;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  .icon-content {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: currentColor;
  }
  
  /* 确保 iconify-icon 能够继承颜色 */
  iconify-icon {
    color: currentColor;
    display: inline-flex !important;
    align-items: center;
    justify-content: center;
    font-size: inherit;
    line-height: 1;
    vertical-align: middle;
  }
  
  /* 确保 iconify-icon 内部的 SVG 填满容器 */
  iconify-icon svg {
    width: 100% !important;
    height: 100% !important;
    display: block;
  }
  
  [data-icon-container] {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 1em;
    min-height: 1em;
  }
  
  [data-icon-container] .icon-loading,
  [data-icon-container] .icon-content {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }
</style>