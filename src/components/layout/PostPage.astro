---
import type { CollectionEntry } from "astro:content";
import { getPostUrlBySlug } from "@utils/url-utils";
import PostCard from "@/components/content/PostCard.astro";
import DynamicWelcome from "@/components/content/DynamicWelcome.astro";
import { siteConfig } from "@/config";
import { Icon } from "astro-icon/components";
import { i18n } from "@i18n/translation";
import I18nKey from "@i18n/i18nKey";

const { page } = Astro.props;

let delay = 0;
const interval = 50;

// 类型别名避免Fragment语法问题
type PostEntry = CollectionEntry<"posts">;



// 根据配置设置初始布局模式，避免闪烁
const defaultLayout = siteConfig.postListLayout.defaultMode || "list";
const initialLayoutClass =
	defaultLayout === "grid"
		? "grid grid-cols-1 md:grid-cols-2 gap-4 grid-mode"
		: "flex flex-col gap-4 md:gap-4 list-mode";
---

<!-- 动态欢迎语 -->
<DynamicWelcome />

<!-- 导航卡片部分 -->
<div class="grid grid-cols-2 gap-4 mb-4 onload-animation">
  <!-- 文章归档卡片 -->
  <a 
    href="/archive/" 
    class="card-base shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1 w-full rounded-lg md:rounded-2xl"
  >
    <div class="p-4 flex flex-row items-center gap-3">
      <div class="rounded-full p-3 flex-shrink-0" style="--dark-bg-color: #403A3D; --dark-color: #FFB86C; background-color: #F8ECF6;">
        <Icon name="feather:archive" class="w-6 h-6" style="color: #C148AC;" />
      </div>
      <div class="min-w-0 flex-1">
        <h2 class="font-bold text-lg leading-tight mb-0.5">{i18n(I18nKey.archive)}</h2>
        <p class="text-sm opacity-75 truncate">按日期浏览文章</p>
      </div>
    </div>
  </a>
  
  <!-- 分类卡片 -->
  <a 
    href="/categories/" 
    class="card-base shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1 w-full rounded-lg md:rounded-2xl"
  >
    <div class="p-4 flex flex-row items-center gap-3">
      <div class="rounded-full p-3 flex-shrink-0" style="--dark-bg-color: #403446; --dark-color: #FB77C3; background-color: #E5F0FF;">
        <Icon name="feather:folder" class="w-6 h-6" style="color: #0069FF;" />
      </div>
      <div class="min-w-0 flex-1">
        <h2 class="font-bold text-lg leading-tight mb-0.5">{i18n(I18nKey.categories)}</h2>
        <p class="text-sm opacity-75 truncate">探索博客的所有分类</p>
      </div>
    </div>
  </a>
  
  <!-- 标签卡片 -->
  <a 
    href="/tags/" 
    class="card-base shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1 w-full rounded-lg md:rounded-2xl"
  >
    <div class="p-4 flex flex-row items-center gap-3">
      <div class="rounded-full p-3 flex-shrink-0" style="--dark-bg-color: #3A374B; --dark-color: #BD93F9; background-color: #ECEBF5;">
        <Icon name="feather:tag" class="w-6 h-6" style="color: #463AA2;" />
      </div>
      <div class="min-w-0 flex-1">
        <h2 class="font-bold text-lg leading-tight mb-0.5">{i18n(I18nKey.tags)}</h2>
        <p class="text-sm opacity-75 truncate">探索博客的所有标签</p>
      </div>
    </div>
  </a>
  
  <!-- 搜索卡片 -->
  <a 
    href="/search/" 
    class="card-base shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1 w-full rounded-lg md:rounded-2xl"
  >
    <div class="p-4 flex flex-row items-center gap-3">
      <div class="rounded-full p-3 flex-shrink-0" style="--dark-bg-color: #353F4B; background-color: #F4FCFE;">
        <Icon name="feather:search" class="w-6 h-6" style="--dark-color: #8BE9FD; color: #93E7FB;" />
      </div>
      <div class="min-w-0 flex-1">
        <h2 class="font-bold text-lg leading-tight mb-0.5">{i18n(I18nKey.search)}</h2>
        <p class="text-sm opacity-75 truncate">搜索博客的所有文章</p>
      </div>
    </div>
  </a>
</div>

<div
  id="post-list-container"
  class={`transition-all duration-500 ease-in-out mb-4 ${initialLayoutClass}`}
  data-default-layout={defaultLayout}
>
  {
    page.data.map((entry: PostEntry) => (
      <PostCard
        entry={entry}
        title={entry.data.title}
        published={entry.data.published}
        url={getPostUrlBySlug(entry.id)}
        image={entry.data.image}
        description={entry.data.description}
        class:list="onload-animation post-card-item"
        style={`animation-delay: calc(var(--content-delay) + ${delay++ * interval}ms);`}
      />
    ))
  }
</div>

<!-- 立即执行脚本：防止刷新时的布局闪烁 -->
<script is:inline define:vars={{ defaultLayout }}>
  (function() {
    const savedLayout = localStorage.getItem('postListLayout');
    const currentLayout = savedLayout || defaultLayout;
    
    // 如果有保存的布局且与默认布局不同，更新容器布局
    if (savedLayout && savedLayout !== defaultLayout) {
      const container = document.getElementById('post-list-container');
      
      if (container) {
        // 禁用过渡动画
        container.style.transition = 'none';
        
        // 移除所有布局类
        container.classList.remove('list-mode', 'grid-mode', 'flex', 'flex-col', 'grid', 'grid-cols-1', 'md:grid-cols-2', 'gap-4', 'md:gap-4');
        
        if (savedLayout === 'grid') {
          container.classList.add('grid-mode', 'grid', 'grid-cols-1', 'md:grid-cols-2', 'gap-4');
        } else {
          container.classList.add('list-mode', 'flex', 'flex-col', 'gap-4', 'md:gap-4');
        }
        
        // 强制重排后恢复过渡动画
        container.offsetHeight;
        container.style.transition = '';
      }
    }
    
    // 始终处理网格布局状态（无论是否有保存的布局）
    // 使用立即执行确保在页面渲染前应用
    (function() {
      const mainGrid = document.getElementById('main-grid');
      
      if (currentLayout === 'grid') {
        if (mainGrid) {
          mainGrid.classList.add('grid-layout-active');
        }
      } else {
        if (mainGrid) {
          mainGrid.classList.remove('grid-layout-active');
        }
      }
    })();
  })();
</script>

<script>
  // 动态布局切换脚本
  function initLayout() {
    const postListContainer = document.getElementById("post-list-container");
    if (!postListContainer) return;

    // 检查屏幕宽度
    const screenWidth = window.innerWidth;
    const isSmallScreen = screenWidth < 1200;

    // 从localStorage读取用户偏好
    const savedLayout = localStorage.getItem("postListLayout");
    const defaultLayout =
      postListContainer.getAttribute("data-default-layout") || "list";
    let currentLayout = savedLayout || defaultLayout;

    // 如果屏幕宽度小于1200px，强制使用列表模式
    if (isSmallScreen) {
      currentLayout = "list";
    }

    // 应用布局
    updatePostListLayout(currentLayout);
  }

  function updatePostListLayout(layout: string) {
    const postListContainer = document.getElementById("post-list-container");
    if (!postListContainer) return;

    // 添加切换动画类
    postListContainer.classList.add("layout-switching");

    // 移除现有布局类
    postListContainer.classList.remove("list-mode", "grid-mode");
    
    const mainGrid = document.getElementById('main-grid');

    // 添加新布局类
    if (layout === "grid") {
      postListContainer.classList.add("grid-mode");
      // 网格模式：双列布局
      postListContainer.classList.add("grid", "grid-cols-1", "md:grid-cols-2", "gap-4");
      postListContainer.classList.remove("flex", "flex-col");
      
      // 标记网格模式状态
      if (mainGrid) {
        mainGrid.classList.add('grid-layout-active');
      }
    } else {
      postListContainer.classList.add("list-mode");
      // 列表模式：单列布局
      postListContainer.classList.add("flex", "flex-col", "gap-4", "md:gap-4");
      postListContainer.classList.remove("grid", "grid-cols-1", "md:grid-cols-2");
      
      // 移除网格模式标记
      if (mainGrid) {
        mainGrid.classList.remove('grid-layout-active');
      }
    }

    // 移除切换动画类
    setTimeout(() => {
      postListContainer.classList.remove("layout-switching");
    }, 500);
  }

  // 页面加载时初始化布局
  document.addEventListener("DOMContentLoaded", function () {
    // 延迟一点确保DOM完全加载
    setTimeout(initLayout, 50);
  });

  // 页面显示时也初始化布局（处理页面切换）
  document.addEventListener("visibilitychange", function () {
    if (!document.hidden) {
      setTimeout(initLayout, 100);
    }
  });

  // 监听布局变化事件
  window.addEventListener("layoutChange", function (event: CustomEvent) {
    const newLayout = event.detail.layout;
    const postListContainer = document.getElementById("post-list-container");
    if (!postListContainer) return;
    
    // 检查屏幕宽度，如果小于1200px则强制使用列表模式
    const screenWidth = window.innerWidth;
    const isSmallScreen = screenWidth < 1200;

    if (isSmallScreen) {
      updatePostListLayout("list");
    } else {
      updatePostListLayout(newLayout);
    }
  });

  // 监听窗口大小变化
  let resizeTimeout: any;
  window.addEventListener("resize", function () {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function () {
      initLayout();
    }, 250);
  });

  // 监听页面导航事件（Astro的客户端路由）
  document.addEventListener("astro:page-load", function () {
    setTimeout(initLayout, 50);
  });
  document.addEventListener("astro:after-swap", function () {
    setTimeout(initLayout, 50);
  });

  // 立即执行一次（处理页面刷新）
  setTimeout(initLayout, 0);
</script>

<style>
  /* 布局切换动画 */
  #post-list-container {
    /* 限制过渡属性为 opacity 和 transform，避免响应父元素位置变化 */
    transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1), 
                transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* 文章卡片的过渡动画 */
  #post-list-container > :global(*) {
    transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* 布局切换时的动画效果 */
  #post-list-container.layout-switching {
    opacity: 0.95;
  }

  #post-list-container.layout-switching > :global(*) {
    transform: scale(0.98);
  }

  /* 列表模式的特殊动画 - 从左到右 */
  #post-list-container.list-mode > :global(*) {
    animation: fadeInSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  @keyframes fadeInSlide {
    from {
      opacity: 0;
      transform: translateX(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  /* 导航卡片颜色样式 */
  /* 白天模式下导航卡片文字颜色 */
  .card-base > div h2 {
    color: #394E6A !important;
  }

  .card-base > div p {
    color: #394E6A !important;
    opacity: 0.75 !important;
  }

  html.dark .card-base > div > div[style*="--dark-bg-color"] {
    background-color: var(--dark-bg-color) !important;
  }

  html.dark .card-base > div > div[style*="--dark-color"] svg {
    color: var(--dark-color) !important;
  }

  /* 黑暗模式下导航卡片文字颜色 */
  html.dark .card-base > div h2 {
    color: white !important;
  }

  html.dark .card-base > div p {
    color: var(--content-meta) !important;
    opacity: 1 !important;
  }
</style>
