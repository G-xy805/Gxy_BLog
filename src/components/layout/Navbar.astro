---
import { Icon } from "astro-icon/components";

import LightDarkSwitch from "@/components/interactive/LightDarkSwitch.svelte";
import { navBarConfig, siteConfig } from "@/config";
import { LinkPresets } from "@/constants/link-presets";
import { LinkPreset, type NavBarLink } from "@/types/config";
import { isHomePage } from "@/utils/layout-utils";
import { url } from "@/utils/url-utils";
import DropdownMenu from "./DropdownMenu.astro";
import NavMenuPanel from "./NavMenuPanel.astro";

const className = Astro.props.class;

// 获取导航栏标题，如果没有设置则使用 siteConfig.title
const navbarTitle = siteConfig.navbarTitle || siteConfig.title;

// 检查是否为首页
const isHomePageCheck = isHomePage(Astro.url.pathname);

// 处理导航链接
let links: NavBarLink[] = navBarConfig.links.map(
	(item: NavBarLink | LinkPreset): NavBarLink => {
		if (typeof item === "number") {
			return LinkPresets[item];
		}
		return item;
	},
);
---
<div id="navbar" class:list={[
        className,
        "z-50 !overflow-visible max-w-7xl mx-auto w-full h-[4rem] flex items-center justify-between px-4 relative whitespace-nowrap"]} data-is-home={isHomePageCheck} role="navigation" aria-label="主导航">
        

        
        <!-- 导航栏左侧：标题 -->
        <div class="flex items-center flex-shrink-0 md:rounded-l-xl md:overflow-hidden">
            <a href={url('/')} class="btn-plain scale-animation md:rounded-xl h-[2.75rem] px-5 font-bold active:scale-95 relative group z-10 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]/50 focus:ring-offset-2">
                <div class="flex flex-row text-[var(--primary)] items-center text-[1.75rem] leading-[1]">
                    <span class="navbar-title-text">{navbarTitle}</span>
                </div>
                <div class="absolute -bottom-1 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-[var(--primary)] to-transparent scale-x-0 group-hover:scale-x-100 transition-transform duration-500 origin-center"></div>
                <div class="absolute inset-0 rounded-xl bg-inherit opacity-0 group-hover:opacity-100 transition-opacity duration-500 -z-10"></div>
            </a>
        </div>
        
        <!-- 导航栏中间：菜单 -->
        <div class="hidden md:flex items-center justify-center flex-1">
            <nav class="flex items-center space-x-1 justify-center" aria-label="主导航菜单">
                {links.map((l) => {
                    return <DropdownMenu link={l} class="group flex-shrink-0" />;
                })}
            </nav>
        </div>
        
        <!-- 导航栏右侧：操作区 -->
        <div class="flex items-center gap-2 z-10 flex-shrink-0 md:rounded-r-xl md:overflow-hidden" role="toolbar" aria-label="工具">
            <!-- 搜索图标按钮 -->
            <a href="/search/" aria-label="搜索" class="btn-plain scale-animation rounded-full w-11 h-11 active:scale-95 group relative overflow-hidden focus:outline-none focus:ring-2 focus:ring-[var(--primary)]/50 focus:ring-offset-2 flex-shrink-0 flex items-center justify-center">
                <div class="absolute inset-0 bg-gradient-to-br from-[var(--primary)]/10 to-[var(--secondary)]/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                <Icon name="ri:search-line" class="text-[1.35rem] text-[var(--primary)] transition-transform duration-300 group-hover:scale-110 group-hover:rotate-12 flex-shrink-0 w-[1.35rem] h-[1.35rem]"></Icon>
            </a>

            <!-- 主题切换按钮 -->
            <LightDarkSwitch client:only="svelte" class="group focus:outline-none focus:ring-2 focus:ring-[var(--primary)]/50 focus:ring-offset-2 flex-shrink-0"></LightDarkSwitch>
            
            <!-- 移动端菜单按钮 -->
            <button 
                aria-label="菜单" 
                aria-expanded="false" 
                aria-controls="nav-menu-panel" 
                name="导航菜单" 
                class="btn-plain scale-animation rounded-full w-11 h-11 active:scale-95 md:!hidden ml-1 group relative overflow-hidden focus:outline-none focus:ring-2 focus:ring-[var(--primary)]/50 focus:ring-offset-2 flex-shrink-0 flex items-center justify-center"
                id="nav-menu-switch"
            >
                <div class="absolute inset-0 bg-gradient-to-br from-[var(--primary)]/10 to-[var(--secondary)]/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                <Icon name="ri:menu-line" class="text-[1.35rem] text-[var(--primary)] transition-all duration-400 group-hover:rotate-90 group-hover:scale-110 flex-shrink-0 w-[1.35rem] h-[1.35rem]"></Icon>
            </button>
        </div>
        

</div>

<!-- 移动端导航菜单面板 -->
<NavMenuPanel links={links}></NavMenuPanel>

<!-- 导航栏脚本 -->
<script type="module">
/**
 * 导航栏脚本
 * 处理导航栏的交互逻辑，包括菜单切换、智能显示/隐藏等功能
 */

// 菜单切换逻辑
function initMenuSwitch() {
    const menuBtn = document.getElementById("nav-menu-switch");
    const menuPanel = document.getElementById("nav-menu-panel");

    if (menuBtn && menuPanel) {
        // 切换菜单状态
        menuBtn.addEventListener('click', function (e) {
            e.stopPropagation();
            const isClosed = menuPanel.classList.contains("float-panel-closed");
            
            if (isClosed) {
                openMenu();
            } else {
                closeMenu();
            }
        });

        // 打开菜单
        function openMenu() {
            menuPanel.classList.remove("float-panel-closed");
            menuBtn.setAttribute("aria-expanded", "true");
            menuBtn.classList.add("active"); // 添加激活状态样式
            
            // 添加菜单打开动画
            menuPanel.style.opacity = "0";
            menuPanel.style.transform = "translateY(-10px)";
            
            setTimeout(() => {
                menuPanel.style.opacity = "1";
                menuPanel.style.transform = "translateY(0)";
            }, 10);
            
            // 延迟添加监听器，等待动画完成后才监听外部点击，防止立即触发
            setTimeout(() => {
                document.addEventListener('click', closeMenuOutside);
                document.addEventListener('keydown', closeMenuEsc);
            }, 300);
        }

        // 关闭菜单
        function closeMenu() {
            // 添加菜单关闭动画
            menuPanel.style.opacity = "1";
            menuPanel.style.transform = "translateY(0)";
            
            setTimeout(() => {
                menuPanel.style.opacity = "0";
                menuPanel.style.transform = "translateY(-10px)";
            }, 10);
            
            setTimeout(() => {
                menuPanel.classList.add("float-panel-closed");
                menuBtn.setAttribute("aria-expanded", "false");
                menuBtn.classList.remove("active");
                
                document.removeEventListener('click', closeMenuOutside);
                document.removeEventListener('keydown', closeMenuEsc);
            }, 300);
        }

        // 点击外部关闭
        function closeMenuOutside(e) {
            if (!menuPanel.contains(e.target) && !menuBtn.contains(e.target)) {
                closeMenu();
            }
        }

        // ESC键关闭
        function closeMenuEsc(e) {
            if (e.key === 'Escape') {
                closeMenu();
            }
        }
    }
}

// 导航栏逻辑（始终显示，取消自动隐藏功能）
function initSmartNavbar() {
    const navbar = document.getElementById('navbar');
    if (!navbar) return;

    // 初始化 ARIA 状态，始终设置为可见
    navbar.setAttribute('aria-hidden', 'false');

    // 无论是否为移动端，都让导航栏始终显示
    function showNavbar() {
        // 确保导航栏可见
        navbar.classList.add('navbar-visible');
        navbar.setAttribute('aria-hidden', 'false');
        
        // 移除任何可能的隐藏动画样式
        navbar.style.transform = 'translateY(0)';
        navbar.style.opacity = '1';
    }

    // 立即显示导航栏
    showNavbar();

    // 确保导航栏在页面加载和滚动时始终显示
    window.addEventListener('load', showNavbar);
    window.addEventListener('scroll', showNavbar);
    window.addEventListener('resize', showNavbar);

    // 为了确保导航栏始终显示，我们可以添加一个样式规则来强制显示
    const style = document.createElement('style');
    style.textContent = `
        #navbar {
            display: flex !important;
            transform: translateY(0) !important;
            opacity: 1 !important;
        }
        
        #navbar.navbar-visible {
            display: flex !important;
        }
    `;
    document.head.appendChild(style);
}

// 滚动事件处理
function initScrollEvents() {
    const navbar = document.getElementById('navbar');
    if (!navbar) return;

    // 初始状态
    if (window.scrollY > 50) {
        navbar.classList.add('scrolled');
    }

    // 节流函数
    function throttle(func, delay) {
        let inThrottle;
        return function(...args) {
            if (!inThrottle) {
                func.apply(this, args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, delay);
            }
        };
    }

    // 添加节流后的滚动事件监听器
    window.addEventListener('scroll', throttle(() => {
        if (window.scrollY > 50) {
            if (!navbar.classList.contains('scrolled')) {
                navbar.classList.add('scrolled');
            }
        } else {
            if (navbar.classList.contains('scrolled')) {
                navbar.classList.remove('scrolled');
            }
        }
    }, 100));
}

// 重置菜单状态
function resetMenuState() {
    const menuPanel = document.getElementById("nav-menu-panel");
    const menuBtn = document.getElementById("nav-menu-switch");
    
    if (menuPanel && menuBtn) {
        // 强制重置菜单为关闭状态
        menuPanel.classList.add("float-panel-closed");
        menuPanel.style.opacity = "0";
        menuPanel.style.transform = "translateY(-10px)";
        menuBtn.setAttribute("aria-expanded", "false");
        menuBtn.classList.remove("active");
        
        // 移除所有可能的事件监听器（使用匿名函数的方式）
        // 由于无法直接引用内部函数，我们通过克隆元素来移除所有监听器
        const newMenuBtn = menuBtn.cloneNode(true);
        menuBtn.parentNode?.replaceChild(newMenuBtn, menuBtn);
    }
}

// 初始化所有导航栏功能
function initNavbar() {
    // 先重置菜单状态
    resetMenuState();
    
    // 等待DOM加载完成
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            initMenuSwitch();
            initSmartNavbar();
            initScrollEvents();
        });
    } else {
        initMenuSwitch();
        initSmartNavbar();
        initScrollEvents();
    }
}

// 导出默认函数
initNavbar();
</script>

<style>
.navbar-title-text {
    display: inline-block;
    transform-origin: top;
    vertical-align: middle;
    transition: all 0.3s ease-in-out;
}

#navbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 50;
    -webkit-backdrop-filter: blur(12px);
    backdrop-filter: blur(12px);
    background: var(--card-bg);
    border-bottom: 1px solid var(--line-color);
    box-shadow: var(--shadow-md);
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: visible;
    transform: translateY(0); /* 默认显示，不再隐藏 */
}

/* 确保直接子div元素继承背景色 */
#navbar > div {
    background: inherit;
    -webkit-backdrop-filter: inherit;
    backdrop-filter: inherit;
}

/* 确保主题切换时的平滑过渡 */
#navbar * {
    transition: color 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                background-color 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                border-color 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                box-shadow 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

#navbar.navbar-visible {
    transform: translateY(0); /* 保持显示状态 */
}

@media (hover: none), (max-width: 768px) {
    #navbar {
        position: sticky;
        top: 0;
        transform: none;
    }
}

#navbar::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--primary), var(--secondary), var(--accent), transparent);
    opacity: 0.5;
}

#navbar.scrolled {
    /* 移除滚动状态的特殊样式，保持统一风格 */
}

:root.dark #navbar.scrolled {
    /* 移除滚动状态的特殊样式，保持统一风格 */
}

#navbar:hover {
    box-shadow: var(--shadow-lg);
}

.btn-plain {
    transition: all 0.3s ease-in-out;
    position: relative;
    overflow: hidden;
}

.btn-plain::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, var(--primary)/10, transparent);
    transition: left 0.5s;
}

.btn-plain:hover::before {
    left: 100%;
}

.btn-plain:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-primary);
}

/* 焦点样式 */
.btn-plain:focus-visible {
    outline: none;
    box-shadow: 0 0 0 3px var(--primary)/30;
}

.navbar-title-text:hover {
    transform: scale(1.05);
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

#nav-menu-switch {
    transition: all 0.3s ease-in-out;
}

#nav-menu-switch:hover {
    transform: rotate(90deg) scale(1.1);
    box-shadow: var(--shadow-primary);
}

/* 响应式设计 */
@media (max-width: 767px) {
    #navbar {
        padding-left: 1rem;
        padding-right: 1rem;
    }
    
    #navbar .navbar-title-text {
        font-size: 1.5rem;
    }
}

@media (max-width: 480px) {
    #navbar .navbar-title-text {
        font-size: 1.25rem;
    }
    
    #navbar .btn-plain {
        width: 2.5rem;
        height: 2.5rem;
    }
    
    #navbar .btn-plain Icon {
        font-size: 1.2rem;
    }
}

@media (min-width: 768px) and (max-width: 1023px) {
    /* 平板端导航栏布局优化 */
    #navbar {
        padding-left: 1.5rem;
        padding-right: 1.5rem;
        /* 确保背景色和边框色与主题一致 */
        background: var(--card-bg);
        border-bottom: 1px solid var(--line-color);
        box-shadow: var(--shadow-md);
    }
    
    /* 调整标题样式 */
    #navbar .navbar-title-text {
        font-size: 1.6rem;
        /* 确保文字颜色与主题一致 */
        color: var(--primary);
    }
    
    /* 调整中间菜单的间距 */
    #navbar > div:nth-child(3) {
        margin-left: 0.5rem;
        margin-right: 0.5rem;
    }
    
    /* 调整导航项的间距 */
    #navbar > div:nth-child(3) nav {
        gap: 0.125rem;
    }
    
    /* 调整右侧操作区的间距 */
    #navbar > div:nth-child(4) {
        gap: 0.75rem;
    }
    
    /* 调整按钮大小和样式 */
    #navbar .btn-plain {
        width: 2.75rem;
        height: 2.75rem;
        /* 确保按钮样式与主题一致 */
        color: var(--text-color);
        transition: all 0.3s ease-in-out;
    }
    
    /* 调整图标大小和颜色 */
    #navbar .btn-plain Icon {
        font-size: 1.25rem;
        /* 确保图标颜色与主题一致 */
        color: var(--primary);
    }
    
    /* 调整下拉菜单的按钮大小和样式 */
    #navbar .dropdown-container .btn-plain {
        height: 2.75rem;
        padding: 0 1rem;
        /* 确保下拉按钮样式与主题一致 */
        color: var(--text-color);
    }
    
    /* 调整下拉菜单的箭头颜色 */
    #navbar .dropdown-arrow {
        /* 确保箭头颜色与主题一致 */
        color: var(--text-secondary);
    }
    
    /* 调整导航图标颜色 */
    #navbar .navbar-icon {
        /* 确保导航图标颜色与主题一致 */
        color: var(--primary);
    }
    
    /* 确保主题切换时的平滑过渡 */
    #navbar * {
        transition: color 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                    background-color 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                    border-color 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                    box-shadow 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
}
</style>
