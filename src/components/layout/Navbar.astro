---
import { Icon } from "astro-icon/components";

import LightDarkSwitch from "@/components/interactive/LightDarkSwitch.svelte";
import { navBarConfig, siteConfig } from "@/config";
import { LinkPresets } from "@/constants/link-presets";
import { LinkPreset, type NavBarLink } from "@/types/config";
import { getCategoriesWithPosts } from "@/utils/content-utils";
import { isHomePage } from "@/utils/layout-utils";
import { url } from "@/utils/url-utils";
import DropdownMenu from "./DropdownMenu.astro";
import NavMenuPanel from "./NavMenuPanel.astro";

const className = Astro.props.class;

// 获取导航栏标题，如果没有设置则使用 siteConfig.title
const navbarTitle = siteConfig.navbarTitle || siteConfig.title;

// 检查是否为首页
const isHomePageCheck = isHomePage(Astro.url.pathname);

// 获取所有分类
const categoriesWithPosts = await getCategoriesWithPosts();

// 将分类转换为导航链接格式
const categoryLinks: NavBarLink[] = categoriesWithPosts.map((category) => ({
	name: category.name,
	url: `/categories/${encodeURIComponent(category.name)}/`,
	icon: "ri:folder-line",
}));

// 处理导航链接 - 动态生成分类下拉菜单
let links: NavBarLink[] = navBarConfig.links.map(
	(item: NavBarLink | LinkPreset): NavBarLink => {
		if (typeof item === "number") {
			return LinkPresets[item];
		}
		// 如果是"分类"链接，动态添加所有分类作为子菜单
		if (item.name === "分类" && item.url === "/categories/") {
			return {
				...item,
				children: categoryLinks,
			} as NavBarLink;
		}
		return item;
	},
);
---
<div id="navbar" class:list={[
        className,
        "z-50 !overflow-visible max-w-7xl mx-auto w-full h-[4rem] flex items-center justify-between px-4 relative whitespace-nowrap"]} data-is-home={isHomePageCheck} role="navigation" aria-label="主导航">
        

        
        <!-- 导航栏左侧：标题 -->
        <div class="flex items-center flex-shrink-0 md:rounded-l-xl md:overflow-hidden">
            <a href={url('/')} class="btn-plain scale-animation md:rounded-xl h-[2.75rem] px-5 font-bold active:scale-95 relative group z-10 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]/50 focus:ring-offset-2">
                <div class="flex flex-row text-[var(--primary)] items-center text-[1.75rem] leading-[1]">
                    <span class="navbar-title-text">{navbarTitle}</span>
                </div>
                <div class="absolute -bottom-1 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-[var(--primary)] to-transparent scale-x-0 group-hover:scale-x-100 transition-transform duration-500 origin-center"></div>
                <div class="absolute inset-0 rounded-xl bg-inherit opacity-0 group-hover:opacity-100 transition-opacity duration-500 -z-10"></div>
            </a>
        </div>
        
        <!-- 导航栏中间：菜单 -->
        <div class="hidden md:flex items-center justify-center flex-1">
            <nav class="flex items-center space-x-1 justify-center" aria-label="主导航菜单">
                {links.map((l) => {
                    return <DropdownMenu link={l} class="group flex-shrink-0" />;
                })}
            </nav>
        </div>
        
        <!-- 导航栏右侧：操作区 -->
        <div class="flex items-center gap-2 z-10 flex-shrink-0 md:rounded-r-xl md:overflow-hidden" role="toolbar" aria-label="工具">
            <!-- 搜索图标按钮 -->
            <a href="/search/" aria-label="搜索" class="btn-plain scale-animation rounded-full w-11 h-11 active:scale-95 group relative overflow-hidden focus:outline-none focus:ring-2 focus:ring-[var(--primary)]/50 focus:ring-offset-2 flex-shrink-0 flex items-center justify-center">
                <div class="absolute inset-0 bg-gradient-to-br from-[var(--primary)]/10 to-[var(--secondary)]/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                <Icon name="ri:search-line" class="text-[1.35rem] text-[var(--primary)] transition-transform duration-300 group-hover:scale-110 group-hover:rotate-12 flex-shrink-0 w-[1.35rem] h-[1.35rem]"></Icon>
            </a>

            <!-- 主题切换按钮 -->
            <LightDarkSwitch client:only="svelte" class="group focus:outline-none focus:ring-2 focus:ring-[var(--primary)]/50 focus:ring-offset-2 flex-shrink-0"></LightDarkSwitch>
            
            <!-- 移动端菜单按钮 -->
            <button 
                aria-label="菜单" 
                aria-expanded="false" 
                aria-controls="nav-menu-panel" 
                name="导航菜单" 
                class="btn-plain scale-animation rounded-full w-11 h-11 active:scale-95 md:!hidden ml-1 group relative overflow-hidden focus:outline-none focus:ring-2 focus:ring-[var(--primary)]/50 focus:ring-offset-2 flex-shrink-0 flex items-center justify-center"
                id="nav-menu-switch"
            >
                <div class="absolute inset-0 bg-gradient-to-br from-[var(--primary)]/10 to-[var(--secondary)]/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                <!-- 菜单图标（收缩状态显示三条横杆） -->
                <svg id="menu-icon-open" class="menu-icon text-[1.35rem] text-[var(--primary)] transition-all duration-300 absolute inset-0 m-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
                <!-- 展开状态显示三条竖杆 -->
                <svg id="menu-icon-close" class="menu-icon text-[1.35rem] text-[var(--primary)] transition-all duration-300 absolute inset-0 m-auto opacity-0 scale-50" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 4v16M12 4v16M18 4v16"></path>
                </svg>
            </button>
        </div>
        

</div>

<!-- 移动端导航菜单面板 -->
<NavMenuPanel links={links}></NavMenuPanel>

<!-- 导航栏脚本 -->
<script type="module">
/**
 * 导航栏脚本 - 使用事件委托模式，确保Swup页面切换后仍能正常工作
 */

// 菜单状态管理
let isMenuOpen = false;

// 获取菜单相关元素（每次使用时动态获取，确保获取到最新的DOM元素）
function getMenuElements() {
    return {
        menuBtn: document.getElementById("nav-menu-switch"),
        menuPanel: document.getElementById("nav-menu-panel"),
        iconOpen: document.querySelector('#menu-icon-open'),
        iconClose: document.querySelector('#menu-icon-close')
    };
}

// 切换图标状态
function toggleMenuIcon(isOpen, iconOpen, iconClose) {
    if (!iconOpen || !iconClose) return;
    
    if (isOpen) {
        iconOpen.classList.add('opacity-0', 'scale-50');
        iconOpen.classList.remove('opacity-100', 'scale-100');
        iconClose.classList.remove('opacity-0', 'scale-50');
        iconClose.classList.add('opacity-100', 'scale-100');
    } else {
        iconOpen.classList.remove('opacity-0', 'scale-50');
        iconOpen.classList.add('opacity-100', 'scale-100');
        iconClose.classList.add('opacity-0', 'scale-50');
        iconClose.classList.remove('opacity-100', 'scale-100');
    }
}

// 打开菜单
function openMenu() {
    const { menuBtn, menuPanel, iconOpen, iconClose } = getMenuElements();
    if (!menuBtn || !menuPanel) return;
    
    isMenuOpen = true;
    menuPanel.classList.remove("float-panel-closed");
    menuBtn.setAttribute("aria-expanded", "true");
    menuBtn.classList.add("active");
    
    toggleMenuIcon(true, iconOpen, iconClose);
    
    // 添加菜单打开动画
    menuPanel.style.opacity = "0";
    menuPanel.style.transform = "translateY(-10px)";
    
    requestAnimationFrame(() => {
        menuPanel.style.opacity = "1";
        menuPanel.style.transform = "translateY(0)";
    });
}

// 关闭菜单
function closeMenu() {
    const { menuBtn, menuPanel, iconOpen, iconClose } = getMenuElements();
    if (!menuBtn || !menuPanel) return;
    
    isMenuOpen = false;
    
    // 添加菜单关闭动画
    menuPanel.style.opacity = "1";
    menuPanel.style.transform = "translateY(0)";
    
    requestAnimationFrame(() => {
        menuPanel.style.opacity = "0";
        menuPanel.style.transform = "translateY(-10px)";
    });
    
    setTimeout(() => {
        menuPanel.classList.add("float-panel-closed");
        menuBtn.setAttribute("aria-expanded", "false");
        menuBtn.classList.remove("active");
        toggleMenuIcon(false, iconOpen, iconClose);
    }, 300);
}

// 使用事件委托处理菜单按钮点击
document.addEventListener('click', function(e) {
    const menuBtn = e.target.closest('#nav-menu-switch');
    if (menuBtn) {
        e.preventDefault();
        e.stopPropagation();
        
        if (isMenuOpen) {
            closeMenu();
        } else {
            openMenu();
        }
    }
});

// 处理点击外部关闭菜单
document.addEventListener('click', function(e) {
    if (!isMenuOpen) return;
    
    const { menuBtn, menuPanel } = getMenuElements();
    if (!menuBtn || !menuPanel) return;
    
    // 如果点击的是菜单按钮或其子元素，不处理（由上面的监听器处理）
    if (e.target.closest('#nav-menu-switch')) return;
    
    // 如果点击在菜单面板外部，关闭菜单
    if (!menuPanel.contains(e.target)) {
        closeMenu();
    }
});

// ESC键关闭菜单
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && isMenuOpen) {
        closeMenu();
    }
});

// 导航栏逻辑（始终显示，取消自动隐藏功能）
function initSmartNavbar() {
    const navbar = document.getElementById('navbar');
    if (!navbar) return;

    // 初始化 ARIA 状态，始终设置为可见
    navbar.setAttribute('aria-hidden', 'false');

    // 无论是否为移动端，都让导航栏始终显示
    function showNavbar() {
        // 确保导航栏可见
        navbar.classList.add('navbar-visible');
        navbar.setAttribute('aria-hidden', 'false');
        
        // 移除任何可能的隐藏动画样式
        navbar.style.transform = 'translateY(0)';
        navbar.style.opacity = '1';
    }

    // 立即显示导航栏
    showNavbar();

    // 确保导航栏在页面加载和滚动时始终显示
    window.addEventListener('load', showNavbar);
    window.addEventListener('scroll', showNavbar);
    window.addEventListener('resize', showNavbar);

    // 为了确保导航栏始终显示，我们可以添加一个样式规则来强制显示
    const style = document.createElement('style');
    style.textContent = `
        #navbar {
            display: flex !important;
            transform: translateY(0) !important;
            opacity: 1 !important;
        }
        
        #navbar.navbar-visible {
            display: flex !important;
        }
    `;
    document.head.appendChild(style);
}

// 滚动事件处理
function initScrollEvents() {
    const navbar = document.getElementById('navbar');
    if (!navbar) return;

    // 初始状态
    if (window.scrollY > 50) {
        navbar.classList.add('scrolled');
    }

    // 节流函数
    function throttle(func, delay) {
        let inThrottle;
        return function(...args) {
            if (!inThrottle) {
                func.apply(this, args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, delay);
            }
        };
    }

    // 添加节流后的滚动事件监听器
    window.addEventListener('scroll', throttle(() => {
        if (window.scrollY > 50) {
            if (!navbar.classList.contains('scrolled')) {
                navbar.classList.add('scrolled');
            }
        } else {
            if (navbar.classList.contains('scrolled')) {
                navbar.classList.remove('scrolled');
            }
        }
    }, 100));
}

// 重置菜单状态
function resetMenuState() {
    const menuPanel = document.getElementById("nav-menu-panel");
    const menuBtn = document.getElementById("nav-menu-switch");
    
    if (menuPanel && menuBtn) {
        // 移除初始化标记，允许重新绑定事件
        delete menuBtn.dataset.menuInitialized;
        
        // 强制重置菜单为关闭状态
        menuPanel.classList.add("float-panel-closed");
        menuPanel.style.opacity = "0";
        menuPanel.style.transform = "translateY(-10px)";
        menuBtn.setAttribute("aria-expanded", "false");
        menuBtn.classList.remove("active");
        
        // 重置图标状态
        const iconOpen = menuBtn.querySelector('#menu-icon-open');
        const iconClose = menuBtn.querySelector('#menu-icon-close');
        if (iconOpen && iconClose) {
            iconOpen.classList.remove('opacity-0', 'scale-50', 'rotate-90');
            iconOpen.classList.add('opacity-100', 'scale-100');
            iconClose.classList.add('opacity-0', 'scale-50');
            iconClose.classList.remove('opacity-100', 'scale-100', 'rotate-0');
        }
    }
}

// 初始化所有导航栏功能
function initNavbar() {
    // 重置菜单状态
    resetMenuState();
    
    // 初始化导航栏显示逻辑和滚动事件
    // 注意：菜单按钮点击事件使用事件委托，在页面加载时已绑定到document，
    // 不需要在这里初始化，这样可以确保Swup页面切换后仍然有效
    initSmartNavbar();
    initScrollEvents();
    
    // 初始化移动端下拉菜单（如果存在）
    if (typeof window !== 'undefined' && window.initMobileDropdowns) {
        window.initMobileDropdowns();
    }
}

// 等待DOM加载完成后初始化
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initNavbar);
} else {
    initNavbar();
}

// 监听 Swup 页面切换事件，重新初始化
if (typeof window !== 'undefined') {
    document.addEventListener('swup:contentReplaced', () => {
        // 使用 requestAnimationFrame 确保 DOM 已更新
        requestAnimationFrame(() => {
            initNavbar();
        });
    });
    
    // 同时监听 Astro 的页面加载事件
    document.addEventListener('astro:page-load', () => {
        requestAnimationFrame(() => {
            initNavbar();
        });
    });
}
</script>

<style>
.navbar-title-text {
    display: inline-block;
    transform-origin: top;
    vertical-align: middle;
    transition: all 0.3s ease-in-out;
}

#navbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 50;
    -webkit-backdrop-filter: blur(12px);
    backdrop-filter: blur(12px);
    background: var(--card-bg);
    border-bottom: 1px solid var(--line-color);
    box-shadow: var(--shadow-md);
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: visible;
    transform: translateY(0); /* 默认显示，不再隐藏 */
}

/* 确保直接子div元素继承背景色 */
#navbar > div {
    background: inherit;
    -webkit-backdrop-filter: inherit;
    backdrop-filter: inherit;
}

/* 确保主题切换时的平滑过渡 */
#navbar * {
    transition: color 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                background-color 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                border-color 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                box-shadow 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

#navbar.navbar-visible {
    transform: translateY(0); /* 保持显示状态 */
}

@media (hover: none), (max-width: 768px) {
    #navbar {
        position: sticky;
        top: 0;
        transform: none;
    }
}

#navbar::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--primary), var(--secondary), var(--accent), transparent);
    opacity: 0.5;
}

#navbar.scrolled {
    /* 移除滚动状态的特殊样式，保持统一风格 */
}

:root.dark #navbar.scrolled {
    /* 移除滚动状态的特殊样式，保持统一风格 */
}

#navbar:hover {
    box-shadow: var(--shadow-lg);
}

.btn-plain {
    transition: all 0.3s ease-in-out;
    position: relative;
    overflow: hidden;
}

.btn-plain::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, var(--primary)/10, transparent);
    transition: left 0.5s;
}

.btn-plain:hover::before {
    left: 100%;
}

.btn-plain:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-primary);
}

/* 焦点样式 */
.btn-plain:focus-visible {
    outline: none;
    box-shadow: 0 0 0 3px var(--primary)/30;
}

.navbar-title-text:hover {
    transform: scale(1.05);
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

#nav-menu-switch {
    transition: all 0.3s ease-in-out;
}

#nav-menu-switch:hover {
    box-shadow: var(--shadow-primary);
}

/* 菜单按钮图标样式 */
#nav-menu-switch .menu-icon {
    width: 1.35rem;
    height: 1.35rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

/* 展开状态下的按钮样式 */
#nav-menu-switch[aria-expanded="true"] {
    background: var(--primary)/10;
}

#nav-menu-switch[aria-expanded="true"]:hover {
    transform: scale(1.1);
}

/* 响应式设计 */
@media (max-width: 767px) {
    #navbar {
        padding-left: 1rem;
        padding-right: 1rem;
    }
    
    #navbar .navbar-title-text {
        font-size: 1.5rem;
    }
}

@media (max-width: 480px) {
    #navbar .navbar-title-text {
        font-size: 1.25rem;
    }
    
    #navbar .btn-plain {
        width: 2.5rem;
        height: 2.5rem;
    }
    
    #navbar .btn-plain Icon {
        font-size: 1.2rem;
    }
}

@media (min-width: 768px) and (max-width: 1023px) {
    /* 平板端导航栏布局优化 */
    #navbar {
        padding-left: 1.5rem;
        padding-right: 1.5rem;
        /* 确保背景色和边框色与主题一致 */
        background: var(--card-bg);
        border-bottom: 1px solid var(--line-color);
        box-shadow: var(--shadow-md);
    }
    
    /* 调整标题样式 */
    #navbar .navbar-title-text {
        font-size: 1.6rem;
        /* 确保文字颜色与主题一致 */
        color: var(--primary);
    }
    
    /* 调整中间菜单的间距 */
    #navbar > div:nth-child(3) {
        margin-left: 0.5rem;
        margin-right: 0.5rem;
    }
    
    /* 调整导航项的间距 */
    #navbar > div:nth-child(3) nav {
        gap: 0.125rem;
    }
    
    /* 调整右侧操作区的间距 */
    #navbar > div:nth-child(4) {
        gap: 0.75rem;
    }
    
    /* 调整按钮大小和样式 */
    #navbar .btn-plain {
        width: 2.75rem;
        height: 2.75rem;
        /* 确保按钮样式与主题一致 */
        color: var(--text-color);
        transition: all 0.3s ease-in-out;
    }
    
    /* 调整图标大小和颜色 */
    #navbar .btn-plain Icon {
        font-size: 1.25rem;
        /* 确保图标颜色与主题一致 */
        color: var(--primary);
    }
    
    /* 调整下拉菜单的按钮大小和样式 */
    #navbar .dropdown-container .btn-plain {
        height: 2.75rem;
        padding: 0 1rem;
        /* 确保下拉按钮样式与主题一致 */
        color: var(--text-color);
    }
    
    /* 调整下拉菜单的箭头颜色 */
    #navbar .dropdown-arrow {
        /* 确保箭头颜色与主题一致 */
        color: var(--text-secondary);
    }
    
    /* 调整导航图标颜色 */
    #navbar .navbar-icon {
        /* 确保导航图标颜色与主题一致 */
        color: var(--primary);
    }
    
    /* 确保主题切换时的平滑过渡 */
    #navbar * {
        transition: color 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                    background-color 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                    border-color 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                    box-shadow 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
}
</style>
