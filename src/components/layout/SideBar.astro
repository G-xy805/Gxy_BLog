---
import type { MarkdownHeading } from "astro";
import Profile from "@/components/content/Profile.astro";

import Categories from "@/components/widget/Categories.astro";
import SidebarTOC from "@/components/widget/SidebarTOC.astro";
import SiteStats from "@/components/widget/SiteStats.astro";
import Tags from "@/components/widget/Tags.astro";
import type { WidgetComponentConfig } from "@/types/config";
import { widgetManager } from "@/utils/widget-manager";

interface Props {
	class?: string;
	headings?: MarkdownHeading[];
}

const { class: className, headings } = Astro.props;

// 由于项目已没有右侧边栏，总是使用左侧边栏配置
const topComponents = widgetManager.getComponentsByPosition("top", "left");
const stickyComponents = widgetManager.getComponentsByPosition(
	"sticky",
	"left",
);

// 组件类型到ID的映射
const componentTypeToId = {
	stats: "site-stats",
	calendar: "calendar-widget",
	sidebarToc: "sidebar-toc",
	profile: "profile",

	categories: "categories",
	tags: "tags",
	popularPosts: "popular-posts",
};

// 提取客户端需要的数据
const sidebarConfig = {
	shouldShowSidebar: {
		mobile: widgetManager.shouldShowSidebar("mobile"),
		tablet: widgetManager.shouldShowSidebar("tablet"),
		desktop: widgetManager.shouldShowSidebar("desktop"),
	},
	breakpoints: {
		mobile: 768,
		tablet: 1024,
		desktop: 1280,
	},
};

// 提取组件的 showOnPostPage 配置
const componentsConfig = widgetManager
	.getConfig()
	.leftComponents.filter((c) => c.enable)
	.map((c) => ({
		id: componentTypeToId[c.type as keyof typeof componentTypeToId],
		showOnPostPage: c.showOnPostPage ?? true,
	}));

// 组件映射表
const componentMap = {
	profile: Profile,

	categories: Categories,
	tags: Tags,
	sidebarToc: SidebarTOC,
	stats: SiteStats,
	popularPosts: (await import("@/components/content/PopularPosts.astro"))
		.default,
};

// 渲染组件的辅助函数
function renderComponent(
	component: WidgetComponentConfig,
	index: number,
	_components: WidgetComponentConfig[],
) {
	const ComponentToRender =
		componentMap[component.type as keyof typeof componentMap];
	if (!ComponentToRender) return null;

	// 总是使用左侧边栏配置
	const componentClass = widgetManager.getComponentClass(
		component,
		"left",
		index,
	);
	const componentStyle = widgetManager.getComponentStyle(component, index);

	return {
		Component: ComponentToRender,
		props: {
			class: componentClass,
			style: componentStyle,
			headings: component.type === "sidebarToc" ? headings : undefined,
			configId: component.configId,
			showOnPostPage: component.showOnPostPage,
			...component.customProps,
		},
	};
}
---

<div id="sidebar" class:list={[className, "w-full"]}>
  <!-- 顶部固定组件区域 -->
  {
    topComponents.length > 0 && (
      <div class="flex flex-col w-full gap-4 mb-4">
        {topComponents.map((component, index) => {
          const renderData = renderComponent(component, index, topComponents);
          if (!renderData) return null;

          const { Component, props } = renderData;
          return <Component {...props} />;
        })}
      </div>
    )
  }

  <!-- 粘性组件区域 -->
  {
    stickyComponents.length > 0 && (
      <div
        id="sidebar-sticky"
        class="transition-all duration-700 flex flex-col w-full gap-4 sticky top-4"
      >
        {stickyComponents.map((component, index) => {
          const renderData = renderComponent(
            component,
            index,
            stickyComponents
          );
          if (!renderData) return null;

          const { Component, props } = renderData;
          return <Component {...props} />;
        })}
      </div>
    )
  }
</div>

<!-- 响应式样式和JavaScript -->
<style>
  /* 响应式断点样式 */
  @media (max-width: 768px) {
    #sidebar {
      display: var(--sidebar-mobile-display, none);
    }
    /* 手机端隐藏粘性区域，防止挤压内容 */
    #sidebar-sticky {
      display: none !important;
    }
  }

  @media (min-width: 769px) and (max-width: 1024px) {
    #sidebar {
      display: var(--sidebar-tablet-display, block);
    }
  }

  @media (min-width: 1025px) {
    #sidebar {
      display: var(--sidebar-desktop-display, block);
    }
  }
</style>

<script is:inline define:vars={{ sidebarConfig, componentsConfig }}>
  // 根据 showOnPostPage 配置控制组件显示
  function toggleComponentsVisibility() {
    const isPostPage = window.location.pathname.includes("/posts/");
    const isHomePage = window.location.pathname === "/";
    
    const sidebar = document.getElementById('sidebar');
    if (!sidebar) return;
    
    const widgets = sidebar.querySelectorAll('widget-layout, div[data-id]');
    
    widgets.forEach((widget) => {
      const widgetId = widget.getAttribute('data-id');
      const componentConfig = componentsConfig.find(c => c.id === widgetId);
      
      if (componentConfig) {
        // 特殊处理：侧边栏TOC只在文章详情页显示
        if (widgetId === 'sidebar-toc') {
          widget.style.display = isPostPage ? '' : 'none';
        }
        // 特殊处理：站点统计只在首页显示
        else if (widgetId === 'site-stats') {
          widget.style.display = isHomePage ? '' : 'none';
        }
        // 其他组件的 showOnPostPage 含义：
        // true: 在文章页和非文章页都显示（默认行为）
        // false: 只在非文章页显示，文章页隐藏
        else if (isPostPage && !componentConfig.showOnPostPage) {
          widget.style.display = 'none';
        } else {
          widget.style.display = '';
        }
      }
    });
  }

  // 响应式布局管理
  class SidebarManager {
    constructor() {
      this.config = sidebarConfig;
      this.init();
    }

    init() {
      this.updateResponsiveDisplay();
      toggleComponentsVisibility();
      
      window.addEventListener("resize", () => this.updateResponsiveDisplay());

      // 监听SWUP内容替换事件
      if (typeof window !== "undefined" && window.swup) {
        window.swup.hooks.on("content:replace", () => {
          // 延迟执行以确保DOM已更新
          setTimeout(() => {
            this.updateResponsiveDisplay();
            toggleComponentsVisibility();
          }, 100);
        });
      }
    }

    updateResponsiveDisplay() {
      const breakpoints = this.config.breakpoints;
      const width = window.innerWidth;

      let deviceType;
      if (width < breakpoints.mobile) {
        deviceType = "mobile";
      } else if (width < breakpoints.tablet) {
        deviceType = "tablet";
      } else {
        deviceType = "desktop";
      }

      const shouldShow = this.config.shouldShowSidebar[deviceType];
      const sidebar = document.getElementById("sidebar");

      if (sidebar) {
        sidebar.style.setProperty(
          `--sidebar-${deviceType}-display`,
          shouldShow ? "block" : "none"
        );
      }
    }
  }

  // 页面加载时执行
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      toggleComponentsVisibility();
      new SidebarManager();
    });
  } else {
    toggleComponentsVisibility();
    new SidebarManager();
  }
</script>
