---
title: 31.å®Œç¾è½¬å‘ä»‹ç»ä¸€ä¸‹ å»æ‰stdforwardä¼šæ€æ ·ï¼Ÿ
order: 31
description: è¯¦è§£C++å®Œç¾è½¬å‘çš„åŸç†ã€å®ç°æœºåˆ¶ä»¥åŠå»æ‰std::forwardåçš„å½±å“ï¼ŒåŒ…æ‹¬é€šç”¨å¼•ç”¨ã€å³å€¼å¼•ç”¨å’Œç§»åŠ¨è¯­ä¹‰çš„ç»“åˆä½¿ç”¨
published: 2026-01-23
image: /assets/images/cpp-logo.webp
tags:
- å®Œç¾è½¬å‘
- å³å€¼å¼•ç”¨
- é€šç”¨å¼•ç”¨
category: C++
---
# ğŸ”¬ å®Œç¾è½¬å‘è¯¦è§£ä¸std::forwardçš„é‡è¦æ€§
## ğŸ“– å†…å®¹æ¦‚è§ˆ
å®Œç¾è½¬å‘æ˜¯C++11å¼•å…¥çš„ä¸€é¡¹é‡è¦æŠ€æœ¯ï¼Œç”¨äºåœ¨å‡½æ•°æ¨¡æ¿ä¸­ç²¾ç¡®ä¼ é€’å‚æ•°å¹¶ä¿ç•™åŸå§‹å‚æ•°çš„æ‰€æœ‰å±æ€§ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å®Œç¾è½¬å‘çš„åŸç†ã€å®ç°æœºåˆ¶ï¼Œä»¥åŠå»æ‰std::forwardåçš„å…·ä½“å½±å“å’Œé—®é¢˜ã€‚

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ
## ğŸ“Œ 1. å®Œç¾è½¬å‘çš„å®šä¹‰

å®Œç¾è½¬å‘ï¼ˆPerfect Forwardingï¼‰æ˜¯ C++11 å¼•å…¥çš„ä¸€é¡¹æŠ€æœ¯ï¼Œç”¨äºåœ¨å‡½æ•°æ¨¡æ¿ä¸­**ç²¾ç¡®åœ°ä¼ é€’å‚æ•°**ï¼ŒåŒæ—¶**ä¿ç•™åŸå§‹å‚æ•°çš„æ‰€æœ‰å±æ€§**ï¼ŒåŒ…æ‹¬ï¼š
- å·¦å€¼/å³å€¼å±æ€§
- const/volatile é™å®šç¬¦
- ç±»å‹ä¿¡æ¯
å®Œç¾è½¬å‘çš„æ ¸å¿ƒå®ç°ä¾èµ–äº**é€šç”¨å¼•ç”¨**ï¼ˆUniversal Referenceï¼‰å’Œ**std::forward** å‡½æ•°çš„ç»“åˆä½¿ç”¨ã€‚
## ğŸ“Œ 2. é€šç”¨å¼•ç”¨ï¼ˆä¸‡èƒ½å¼•ç”¨ï¼‰

é€šç”¨å¼•ç”¨æ˜¯æŒ‡åœ¨æ¨¡æ¿å‚æ•°æ¨å¯¼è¿‡ç¨‹ä¸­ï¼Œå½¢å¦‚ `T&&` çš„å¼•ç”¨ç±»å‹ï¼š
```cpp
template <typename T>
void foo(T&& arg) {  // è¿™é‡Œçš„ T&& æ˜¯é€šç”¨å¼•ç”¨
    // ...
}
```
é€šç”¨å¼•ç”¨çš„ç‰¹ç‚¹ï¼š
- åªæœ‰åœ¨æ¨¡æ¿å‚æ•°æ¨å¯¼è¿‡ç¨‹ä¸­ï¼Œä¸”å½¢å¼ä¸º `T&&` æ—¶æ‰æ˜¯é€šç”¨å¼•ç”¨
- å¯ä»¥åŒæ—¶æ¥å—å·¦å€¼å’Œå³å€¼
- ç±»å‹æ¨å¯¼ç»“æœä¼šæ ¹æ®å®å‚ç±»å‹è‡ªåŠ¨è°ƒæ•´ï¼š
  - è‹¥å®å‚æ˜¯å·¦å€¼ï¼ŒT æ¨å¯¼ä¸º `Type&`ï¼Œåˆ™ `T&&` å˜ä¸º `Type& &&`ï¼ŒæŠ˜å ä¸º `Type&`
  - è‹¥å®å‚æ˜¯å³å€¼ï¼ŒT æ¨å¯¼ä¸º `Type`ï¼Œåˆ™ `T&&` å˜ä¸º `Type&&`
## ğŸ› ï¸ 3. std::forward çš„å®ç°åŸç†

std::forward æ˜¯ä¸€ä¸ªæ¨¡æ¿å‡½æ•°ï¼Œç”¨äºå°†é€šç”¨å¼•ç”¨è½¬æ¢ä¸ºåŸå§‹å‚æ•°çš„å®é™…ç±»å‹ï¼š
```cpp
// std::forward çš„ç®€åŒ–å®ç°
template <typename T>
T&& forward(typename std::remove_reference<T>::type& arg) noexcept {
    return static_cast<T&&>(arg);
}

template <typename T>
T&& forward(typename std::remove_reference<T>::type&& arg) noexcept {
    static_assert(!std::is_lvalue_reference<T>::value, "Cannot forward an rvalue as an lvalue");
    return static_cast<T&&>(arg);
}
```
std::forward çš„å·¥ä½œæœºåˆ¶ï¼š
- æ¥å—ä¸€ä¸ªé€šç”¨å¼•ç”¨å‚æ•°
- æ ¹æ®æ¨¡æ¿å‚æ•° T çš„ç±»å‹ï¼Œä½¿ç”¨ static_cast å°†å‚æ•°è½¬æ¢ä¸ºæ­£ç¡®çš„å¼•ç”¨ç±»å‹
- ä¿ç•™åŸå§‹å‚æ•°çš„å·¦å€¼/å³å€¼å±æ€§
ğŸ’» **ä»£ç ç¤ºä¾‹**
### 1. å®Œç¾è½¬å‘çš„åŸºæœ¬ä½¿ç”¨
```cpp
#include <iostream>
#include <utility>

// é‡è½½å‡½æ•°ï¼Œåˆ†åˆ«å¤„ç†å·¦å€¼å’Œå³å€¼
void process(int& x) {
    std::cout << "å¤„ç†å·¦å€¼: " << x << std::endl;
}

void process(int&& x) {
    std::cout << "å¤„ç†å³å€¼: " << x << std::endl;
}

// å®Œç¾è½¬å‘å‡½æ•°
template <typename T>
void forwarder(T&& arg) {
    process(std::forward<T>(arg));  // ä½¿ç”¨ std::forward ä¿ç•™åŸå§‹å±æ€§
}

int main() {
    int a = 42;
    
    forwarder(a);            // ä¼ é€’å·¦å€¼
    forwarder(100);          // ä¼ é€’å³å€¼
    forwarder(std::move(a));  // ä¼ é€’å³å€¼
    return 0;
}
```
**è¾“å‡ºç»“æœ**ï¼š
å¤„ç†å·¦å€¼: 42
å¤„ç†å³å€¼: 100
å¤„ç†å³å€¼: 42
### 2. å»æ‰ std::forward çš„å½±å“
```cpp
#include <iostream>
#include <string>

void process(const std::string& s) {
    std::cout << "å¤„ç†å·¦å€¼å­—ç¬¦ä¸²: " << s << std::endl;
}

void process(std::string&& s) {
    std::cout << "å¤„ç†å³å€¼å­—ç¬¦ä¸²: " << s << std::endl;
    s = "è¢«ä¿®æ”¹äº†";
}

// ä½¿ç”¨ std::forward çš„ç‰ˆæœ¬
template <typename T>
void with_forward(T&& arg) {
    std::cout << "å¸¦ std::forward: " << std::endl;
    process(std::forward<T>(arg));
}

// ä¸ä½¿ç”¨ std::forward çš„ç‰ˆæœ¬
template <typename T>
void without_forward(T&& arg) {
    std::cout << "ä¸å¸¦ std::forward: " << std::endl;
    process(arg);  // ç›´æ¥ä¼ é€’ï¼Œæ²¡æœ‰ä½¿ç”¨ std::forward
}

int main() {
    std::string s = "Hello";
    
    std::cout << "=== ä¼ é€’å·¦å€¼ ===" << std::endl;
    with_forward(s);
    without_forward(s);
    
    std::cout << "\n=== ä¼ é€’å³å€¼ ===" << std::endl;
    with_forward(std::string("World"));
    without_forward(std::string("World"));
    
    return 0;
}
```
**è¾“å‡ºç»“æœ**ï¼š
```
=== ä¼ é€’å·¦å€¼ ===
å¸¦ std::forward: 
å¤„ç†å·¦å€¼å­—ç¬¦ä¸²: Hello
ä¸å¸¦ std::forward: 
å¤„ç†å·¦å€¼å­—ç¬¦ä¸²: Hello

=== ä¼ é€’å³å€¼ ===
å¸¦ std::forward: 
å¤„ç†å³å€¼å­—ç¬¦ä¸²: World
ä¸å¸¦ std::forward: 
å¤„ç†å·¦å€¼å­—ç¬¦ä¸²: World
```
### 3. å»æ‰ std::forward å¯¼è‡´çš„é—®é¢˜
```cpp
#include <iostream>
#include <vector>

class HeavyObject {
public:
    HeavyObject() { std::cout << "é»˜è®¤æ„é€ " << std::endl; }
    HeavyObject(const HeavyObject&) { std::cout << "æ‹·è´æ„é€ " << std::endl; }
    HeavyObject(HeavyObject&&) noexcept { std::cout << "ç§»åŠ¨æ„é€ " << std::endl; }
    HeavyObject& operator=(const HeavyObject&) { 
        std::cout << "æ‹·è´èµ‹å€¼" << std::endl; 
        return *this; 
    }
    HeavyObject& operator=(HeavyObject&&) noexcept { 
        std::cout << "ç§»åŠ¨èµ‹å€¼" << std::endl; 
        return *this; 
    }
    ~HeavyObject() { std::cout << "ææ„" << std::endl; }
};

// ç›®æ ‡å‡½æ•°ï¼Œæ¥å—å³å€¼å¼•ç”¨
void store_in_container(std::vector<HeavyObject>& vec, HeavyObject&& obj) {
    vec.push_back(std::move(obj));  // é¢„æœŸè°ƒç”¨ç§»åŠ¨æ„é€ 
}

// ä½¿ç”¨ std::forward çš„è½¬å‘å‡½æ•°
template <typename T>
void add_with_forward(std::vector<HeavyObject>& vec, T&& obj) {
    store_in_container(vec, std::forward<T>(obj));
}

// ä¸ä½¿ç”¨ std::forward çš„è½¬å‘å‡½æ•°
template <typename T>
void add_without_forward(std::vector<HeavyObject>& vec, T&& obj) {
    // store_in_container(vec, obj);  // é”™è¯¯ï¼šobj æ˜¯å·¦å€¼ï¼Œæ— æ³•ç»‘å®šåˆ°å³å€¼å¼•ç”¨
    std::cout << "ç¼–è¯‘é”™è¯¯ï¼šæ— æ³•å°†å·¦å€¼ç»‘å®šåˆ°å³å€¼å¼•ç”¨" << std::endl;
}

int main() {
    std::vector<HeavyObject> vec;
    vec.reserve(2);  // é¢„åˆ†é…ç©ºé—´ï¼Œé¿å…æ‰©å®¹
    
    std::cout << "=== ä½¿ç”¨ std::forward ===" << std::endl;
    add_with_forward(vec, HeavyObject());
    
    std::cout << "\n=== ä¸ä½¿ç”¨ std::forward ===" << std::endl;
    add_without_forward(vec, HeavyObject());
    
    return 0;
}
```
**è¾“å‡ºç»“æœ**ï¼š
```
=== ä½¿ç”¨ std::forward ===
é»˜è®¤æ„é€ 
ç§»åŠ¨æ„é€ 
ææ„

=== ä¸ä½¿ç”¨ std::forward ===
é»˜è®¤æ„é€ 
ç¼–è¯‘é”™è¯¯ï¼šæ— æ³•å°†å·¦å€¼ç»‘å®šåˆ°å³å€¼å¼•ç”¨
ææ„
```
## ğŸ“Œ 4. å»æ‰ std::forward çš„å…·ä½“å½±å“

### å½±å“1ï¼šå³å€¼è¢«è½¬æ¢ä¸ºå·¦å€¼
å½“ä¸ä½¿ç”¨ std::forward æ—¶ï¼Œé€šç”¨å¼•ç”¨å‚æ•° `arg` æœ¬èº«æ˜¯ä¸€ä¸ª**å·¦å€¼**ï¼ˆå› ä¸ºå®ƒæœ‰åç§°ä¸”å¯ä»¥å–åœ°å€ï¼‰ï¼Œæ— è®ºå®ƒç»‘å®šçš„åŸå§‹å‚æ•°æ˜¯å·¦å€¼è¿˜æ˜¯å³å€¼ã€‚
è¿™å¯¼è‡´ï¼š
- åŸå§‹å³å€¼å®å‚çš„å³å€¼å±æ€§ä¸¢å¤±
- æ— æ³•è§¦å‘ç§»åŠ¨è¯­ä¹‰ï¼Œåªèƒ½è§¦å‘æ‹·è´è¯­ä¹‰
- æ— æ³•åŒ¹é…æ¥å—å³å€¼å¼•ç”¨çš„é‡è½½å‡½æ•°
### å½±å“2ï¼šæ€§èƒ½ä¸‹é™
ç”±äºå³å€¼å±æ€§ä¸¢å¤±ï¼Œæ— æ³•ä½¿ç”¨ç§»åŠ¨æ„é€ /ç§»åŠ¨èµ‹å€¼ï¼Œåªèƒ½è¿›è¡Œæ‹·è´æ“ä½œï¼Œè¿™ä¼šå¯¼è‡´ï¼š
- é¢å¤–çš„å†…å­˜åˆ†é…å’Œæ•°æ®æ‹·è´
- å¯¹äºå¤§å‹å¯¹è±¡ï¼Œæ€§èƒ½ä¸‹é™æ˜æ˜¾
- æ— æ³•åˆ©ç”¨ç§»åŠ¨è¯­ä¹‰å¸¦æ¥çš„æ€§èƒ½ä¼˜åŠ¿
### å½±å“3ï¼šç¼–è¯‘é”™è¯¯
åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå»æ‰ std::forward ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ï¼š
- å½“ç›®æ ‡å‡½æ•°åªæ¥å—å³å€¼å¼•ç”¨æ—¶
- å½“éœ€è¦å°†å‚æ•°ä¼ é€’ç»™å¦ä¸€ä¸ªå®Œç¾è½¬å‘å‡½æ•°æ—¶
- å½“éœ€è¦ä¿æŒå‚æ•°çš„å³å€¼å±æ€§ä»¥è§¦å‘ç‰¹å®šé‡è½½æ—¶
## ğŸ“Œ 5. å®Œç¾è½¬å‘çš„å…¸å‹åº”ç”¨åœºæ™¯

### åœºæ™¯1ï¼šå·¥å‚å‡½æ•°
```cpp
template <typename T, typename... Args>
std::unique_ptr<T> create(Args&&... args) {
    return std::unique_ptr<T>(new T(std::forward<Args>(args)...));
}
```
### åœºæ™¯2ï¼šåŒ…è£…å‡½æ•°
```cpp
template <typename Func, typename... Args>
auto wrapper(Func&& func, Args&&... args) {
    // å‰ç½®å¤„ç†
    auto result = func(std::forward<Args>(args)...);
    // åç½®å¤„ç†
    return result;
}
```
### åœºæ™¯3ï¼šå®¹å™¨æ’å…¥æ“ä½œ
```cpp
template <typename Container, typename... Args>
void emplace_into(Container& container, Args&&... args) {
    container.emplace(std::forward<Args>(args)...);
}
```
## ğŸ“‹ æ€»ç»“ä¸æœ€ä½³å®è·µ
## ğŸ¯ 1. å®Œç¾è½¬å‘çš„æ ¸å¿ƒè¦ç‚¹

| ç»„ä»¶ | ä½œç”¨ |
|------|------|
| é€šç”¨å¼•ç”¨ï¼ˆT&&ï¼‰ | æ¥å—ä»»æ„ç±»å‹çš„å·¦å€¼å’Œå³å€¼ |
| ç±»å‹æ¨å¯¼ | è‡ªåŠ¨è°ƒæ•´å¼•ç”¨ç±»å‹ |
| std::forward | ä¿ç•™åŸå§‹å‚æ•°çš„å·¦å€¼/å³å€¼å±æ€§ |
## ğŸ“Œ 2. å»æ‰ std::forward çš„åæœ

1. **å³å€¼å±æ€§ä¸¢å¤±**ï¼šæ‰€æœ‰å‚æ•°éƒ½ä¼šè¢«å½“ä½œå·¦å€¼å¤„ç†
2. **æ€§èƒ½ä¸‹é™**ï¼šæ— æ³•è§¦å‘ç§»åŠ¨è¯­ä¹‰ï¼Œåªèƒ½è¿›è¡Œæ‹·è´æ“ä½œ
3. **ç¼–è¯‘é”™è¯¯**ï¼šæ— æ³•åŒ¹é…æ¥å—å³å€¼å¼•ç”¨çš„å‡½æ•°é‡è½½
4. **è¯­ä¹‰é”™è¯¯**ï¼šç ´åäº†å®Œç¾è½¬å‘çš„è®¾è®¡æ„å›¾
## ğŸ“Œ 3. å®Œç¾è½¬å‘çš„æœ€ä½³å®è·µ

1. **å§‹ç»ˆåœ¨è½¬å‘å‚æ•°æ—¶ä½¿ç”¨ std::forward**ï¼š
   ```cpp
   template <typename T>
   void forwarder(T&& arg) {
       target(std::forward<T>(arg));  // æ­£ç¡®ï¼šä½¿ç”¨ std::forward
   }
   ```
2. **åªå¯¹é€šç”¨å¼•ç”¨ä½¿ç”¨ std::forward**ï¼š
   void non_template_func(int&& arg) {
       // è¿™é‡Œçš„ int&& æ˜¯å³å€¼å¼•ç”¨ï¼Œä¸æ˜¯é€šç”¨å¼•ç”¨
       target(std::move(arg));  // æ­£ç¡®ï¼šä½¿ç”¨ std::move
       // target(std::forward<int>(arg));  // é”™è¯¯ï¼šä¸åº”è¯¥å¯¹å³å€¼å¼•ç”¨ä½¿ç”¨ std::forward
3. **ç†è§£ std::forward ä¸ std::move çš„åŒºåˆ«**ï¼š
   - `std::forward<T>(arg)`ï¼šæœ‰æ¡ä»¶åœ°è½¬æ¢ä¸ºå³å€¼ï¼Œä¿ç•™åŸå§‹å±æ€§
   - `std::move(arg)`ï¼šæ— æ¡ä»¶åœ°è½¬æ¢ä¸ºå³å€¼
4. **é¿å…åœ¨è½¬å‘åä½¿ç”¨åŸå§‹å‚æ•°**ï¼š
       target(std::forward<T>(arg));
       // arg å¯èƒ½å·²ç»è¢«ç§»åŠ¨ï¼Œä¸åº”å†ä½¿ç”¨
5. **æ³¨æ„å¯å˜å‚æ•°æ¨¡æ¿çš„å®Œç¾è½¬å‘**ï¼š
   template <typename... Args>
   void forwarder(Args&&... args) {
       target(std::forward<Args>(args)...);  // å¯¹æ¯ä¸ªå‚æ•°ä½¿ç”¨ std::forward
## ğŸ“Œ 4. å¸¸è§è¯¯åŒº

- **è¯¯åŒº1**ï¼šè®¤ä¸ºé€šç”¨å¼•ç”¨å°±æ˜¯å³å€¼å¼•ç”¨
  - é€šç”¨å¼•ç”¨æ˜¯ `T&&` åœ¨æ¨¡æ¿æ¨å¯¼ä¸­çš„ç‰¹æ®Šæƒ…å†µ
  - å³å€¼å¼•ç”¨æ˜¯ `Type&&`ï¼ˆType æ˜¯å…·ä½“ç±»å‹ï¼‰
- **è¯¯åŒº2**ï¼šå¯¹æ‰€æœ‰å¼•ç”¨ç±»å‹éƒ½ä½¿ç”¨ std::forward
  - åªæœ‰é€šç”¨å¼•ç”¨æ‰éœ€è¦ä½¿ç”¨ std::forward
  - å³å€¼å¼•ç”¨åº”è¯¥ä½¿ç”¨ std::move
  - å·¦å€¼å¼•ç”¨ç›´æ¥ä¼ é€’å³å¯
- **è¯¯åŒº3**ï¼šè®¤ä¸ºå®Œç¾è½¬å‘å¯ä»¥è§£å†³æ‰€æœ‰å‚æ•°ä¼ é€’é—®é¢˜
  - å®Œç¾è½¬å‘åªé€‚ç”¨äºæ¨¡æ¿å‡½æ•°
  - éæ¨¡æ¿å‡½æ•°æ— æ³•ä½¿ç”¨å®Œç¾è½¬å‘
å®Œç¾è½¬å‘æ˜¯ C++ ä¸­ä¸€é¡¹å¼ºå¤§çš„æŠ€æœ¯ï¼Œæ­£ç¡®ä½¿ç”¨å¯ä»¥æ˜¾è‘—æé«˜ä»£ç çš„æ•ˆç‡å’Œçµæ´»æ€§ã€‚ä½†éœ€è¦æ·±åˆ»ç†è§£å…¶åŸç†å’Œå®ç°æœºåˆ¶ï¼Œç‰¹åˆ«æ˜¯ std::forward çš„ä½œç”¨ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜æˆ–ç¼–è¯‘é”™è¯¯ã€‚
è®°ä½ï¼š**åœ¨å®Œç¾è½¬å‘ä¸­ï¼Œæ°¸è¿œä¸è¦å»æ‰ std::forwardï¼**