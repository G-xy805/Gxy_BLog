---
title: 32.ä»‹ç»ä¸€ä¸‹unique_lockå’Œlock_guardåŒºåˆ«ï¼Ÿ
order: 32
description: è¯¦è§£C++ä¸­unique_lockå’Œlock_guardçš„åŒºåˆ«ã€ä½¿ç”¨åœºæ™¯å’Œå®ç°åŸç†ï¼Œå¸®åŠ©ç†è§£å¤šçº¿ç¨‹åŒæ­¥æœºåˆ¶
published: '2026-01-23'
image: /assets/images/cpp-logo.webp
tags:
- C++
- å¤šçº¿ç¨‹
- å¹¶å‘
- é”æœºåˆ¶
category: C++
---
# ğŸ”¬ ä»‹ç»ä¸€ä¸‹unique_lockå’Œlock_guardåŒºåˆ«ï¼Ÿ
## ğŸ“– å†…å®¹æ¦‚è§ˆ

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

## ğŸ”„ åŠŸèƒ½è¯¦è§£

## âš ï¸ âš ï¸ âš ï¸ âš ï¸ âš ï¸ âš ï¸ æ³¨æ„äº‹é¡¹

## ğŸ’¡ å…³é”®è¦ç‚¹

## ğŸ“‹ æ€»ç»“


ğŸ“– **å†…å®¹æ¦‚è§ˆ**
- é”çš„åŸºæœ¬æ¦‚å¿µå’Œä½œç”¨
- lock_guardçš„å®ç°åŸç†å’Œä½¿ç”¨æ–¹å¼
- unique_lockçš„å®ç°åŸç†å’Œä½¿ç”¨æ–¹å¼
- ä¸¤ç§é”çš„è¯¦ç»†å¯¹æ¯”
- å„è‡ªçš„é€‚ç”¨åœºæ™¯
- æœ€ä½³å®è·µå’Œå¸¸è§è¯¯åŒº

ğŸ¯ **æ ¸å¿ƒæ¦‚å¿µ**

## ğŸ¯ 1. é”çš„åŸºæœ¬æ¦‚å¿µ

åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œé”æ˜¯ä¸€ç§**åŒæ­¥æœºåˆ¶**ï¼Œç”¨äºé˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å…±äº«èµ„æºè€Œå¯¼è‡´çš„æ•°æ®ç«äº‰å’Œä¸ä¸€è‡´é—®é¢˜ã€‚é”çš„ä¸»è¦ä½œç”¨æ˜¯ï¼š
- ä¿è¯å…±äº«èµ„æºçš„åŸå­è®¿é—®
- é˜²æ­¢æ•°æ®ç«äº‰å’Œç«æ€æ¡ä»¶
- ç¡®ä¿çº¿ç¨‹é—´çš„æ­£ç¡®åŒæ­¥

C++11 å¼•å…¥äº†ä¸¤ç§åŸºäº RAIIï¼ˆèµ„æºè·å–å³åˆå§‹åŒ–ï¼‰çš„é”ç®¡ç†ç±»ï¼š**lock_guard** å’Œ **unique_lock**ã€‚å®ƒä»¬éƒ½ç”¨äºç®¡ç†äº’æ–¥é‡ï¼ˆ`std::mutex`ï¼‰çš„é”å®šå’Œè§£é”ï¼Œé¿å…æ‰‹åŠ¨ç®¡ç†é”çš„å¤æ‚æ€§å’Œæ½œåœ¨çš„æ­»é”é£é™©ã€‚

## ğŸ”„ 2. lock_guard è¯¦è§£

### 2.1 å®šä¹‰å’Œæ ¸å¿ƒåŸç†

`lock_guard` æ˜¯ä¸€ä¸ªç®€å•çš„æ¨¡æ¿ç±»ï¼Œç”¨äºè‡ªåŠ¨ç®¡ç†äº’æ–¥é‡çš„é”å®šå’Œè§£é”ï¼š

```cpp
template <class Mutex>
class lock_guard;
```

å®ƒçš„æ ¸å¿ƒè®¾è®¡åŸåˆ™æ˜¯ï¼š**æ„é€ æ—¶é”å®šï¼Œææ„æ—¶è§£é”**ã€‚

### 2.2 ä¸»è¦ç‰¹æ€§

| ç‰¹æ€§ | æè¿° |
|------|------|
| **è‡ªåŠ¨é”å®š** | æ„é€ å‡½æ•°ä¸­è‡ªåŠ¨è°ƒç”¨ `mutex.lock()` |
| **è‡ªåŠ¨è§£é”** | ææ„å‡½æ•°ä¸­è‡ªåŠ¨è°ƒç”¨ `mutex.unlock()` |
| **ä¸å¯å¤åˆ¶** | ç¦æ­¢æ‹·è´æ„é€ å’Œèµ‹å€¼æ“ä½œ |
| **ä¸å¯ç§»åŠ¨** | ç¦æ­¢ç§»åŠ¨æ„é€ å’Œç§»åŠ¨èµ‹å€¼æ“ä½œ |
| **æ— æ‰‹åŠ¨æ§åˆ¶** | æ— æ³•æ‰‹åŠ¨é”å®šæˆ–è§£é” |
| **è½»é‡çº§** | å®ç°ç®€å•ï¼Œæ€§èƒ½å¼€é”€å° |

### 2.3 ä½¿ç”¨ç¤ºä¾‹

```cpp
#include <thread>
#include <mutex>
#include <iostream>

int g_shared_value = 0;
std::mutex g_mutex;  // å…¨å±€äº’æ–¥é‡

void safe_increment() {
    // æ„é€ æ—¶è‡ªåŠ¨é”å®šï¼Œä½œç”¨åŸŸç»“æŸæ—¶è‡ªåŠ¨è§£é”
    const std::lock_guard<std::mutex> lock(g_mutex);
    
    // ä¸´ç•ŒåŒºï¼šå®‰å…¨è®¿é—®å…±äº«èµ„æº
    ++g_shared_value;
    std::cout << "çº¿ç¨‹ " << std::this_thread::get_id() 
              << ": " << g_shared_value << std::endl;
}

int main() {
    std::cout << "åˆå§‹å€¼: " << g_shared_value << std::endl;
    
    std::thread t1(safe_increment);
    std::thread t2(safe_increment);
    
    t1.join();
    t2.join();
    
    std::cout << "æœ€ç»ˆå€¼: " << g_shared_value << std::endl;
    
    return 0;
}
```

### 2.4 è¾“å‡ºç»“æœ

```cpp
åˆå§‹å€¼: 0
çº¿ç¨‹ 140641306900224: 1
çº¿ç¨‹ 140641298507520: 2
æœ€ç»ˆå€¼: 2
```

## ğŸ”„ 3. unique_lock è¯¦è§£

### 3.1 å®šä¹‰å’Œæ ¸å¿ƒåŸç†

`unique_lock` æ˜¯ä¸€ä¸ªæ›´çµæ´»çš„æ¨¡æ¿ç±»ï¼ŒåŒæ ·ç”¨äºç®¡ç†äº’æ–¥é‡ï¼Œä½†æä¾›äº†æ›´å¤šçš„æ§åˆ¶é€‰é¡¹ï¼š

```cpp
template <class Mutex>
class unique_lock;
```

å®ƒçš„æ ¸å¿ƒè®¾è®¡åŸåˆ™æ˜¯ï¼š**æä¾›çµæ´»çš„é”å®šå’Œè§£é”æœºåˆ¶ï¼ŒåŒæ—¶ä¿è¯ RAII è¯­ä¹‰**ã€‚

### 3.2 ä¸»è¦ç‰¹æ€§

| ç‰¹æ€§ | æè¿° |
|------|------|
| **è‡ªåŠ¨é”å®š/è§£é”** | æ”¯æŒ RAII è¯­ä¹‰ï¼Œææ„æ—¶è‡ªåŠ¨è§£é” |
| **å»¶è¿Ÿé”å®š** | å¯ä»¥åœ¨æ„é€ æ—¶ä¸é”å®šï¼Œç¨åæ‰‹åŠ¨é”å®š |
| **æ‰‹åŠ¨æ§åˆ¶** | æ”¯æŒæ‰‹åŠ¨é”å®šï¼ˆ`lock()`ï¼‰å’Œè§£é”ï¼ˆ`unlock()`ï¼‰ |
| **å¯ç§»åŠ¨** | æ”¯æŒç§»åŠ¨æ„é€ å’Œç§»åŠ¨èµ‹å€¼ï¼Œå¯åœ¨å‡½æ•°é—´ä¼ é€’ |
| **ä¸å¯å¤åˆ¶** | ç¦æ­¢æ‹·è´æ„é€ å’Œèµ‹å€¼æ“ä½œ |
| **æ¡ä»¶å˜é‡æ”¯æŒ** | å¯ä¸ `std::condition_variable` é…åˆä½¿ç”¨ |
| **é”çŠ¶æ€æŸ¥è¯¢** | æ”¯æŒæŸ¥è¯¢å½“å‰é”çŠ¶æ€ï¼ˆ`owns_lock()`ï¼‰ |
| **try_lock æ”¯æŒ** | æ”¯æŒå°è¯•é”å®šï¼ˆ`try_lock()`ï¼‰ |
| **è¶…æ—¶é”å®šæ”¯æŒ** | æ”¯æŒå¸¦è¶…æ—¶çš„é”å®šæ“ä½œ |

### 3.3 æ„é€ å‡½æ•°é€‰é¡¹

`unique_lock` æ”¯æŒå¤šç§æ„é€ æ–¹å¼ï¼Œé€šè¿‡ç¬¬äºŒä¸ªå‚æ•°æ§åˆ¶é”å®šè¡Œä¸ºï¼š

| æ„é€ æ–¹å¼ | æè¿° |
|----------|------|
| `unique_lock(mutex)` | æ„é€ æ—¶è‡ªåŠ¨é”å®š |
| `unique_lock(mutex, defer_lock_t)` | å»¶è¿Ÿé”å®šï¼Œæ„é€ æ—¶ä¸é”å®š |
| `unique_lock(mutex, try_to_lock_t)` | å°è¯•é”å®šï¼Œä¸é˜»å¡ |
| `unique_lock(mutex, adopt_lock_t)` | å‡è®¾å·²é”å®šï¼Œç›´æ¥ç®¡ç† |

### 3.4 ä½¿ç”¨ç¤ºä¾‹

```cpp
#include <thread>
#include <mutex>
#include <iostream>

struct SharedData {
    SharedData(int value) : data(value) {}
    int data;
    std::mutex mutex;
};

void transfer(SharedData& from, SharedData& to, int amount) {
    // å»¶è¿Ÿé”å®šï¼Œæ„é€ æ—¶ä¸é”å®š
    std::unique_lock<std::mutex> lock1(from.mutex, std::defer_lock);
    std::unique_lock<std::mutex> lock2(to.mutex, std::defer_lock);
    
    // åŒæ—¶é”å®šä¸¤ä¸ªäº’æ–¥é‡ï¼Œé¿å…æ­»é”
    std::lock(lock1, lock2);
    
    // ä¸´ç•ŒåŒºï¼šå®‰å…¨è½¬ç§»æ•°æ®
    from.data -= amount;
    to.data += amount;
    
    std::cout << "è½¬ç§» " << amount << "ï¼Œ" 
              << "from: " << from.data << "ï¼Œ" 
              << "to: " << to.data << std::endl;
    
    // å¯ä»¥æ‰‹åŠ¨è§£é”ï¼ˆå¯é€‰ï¼Œææ„æ—¶ä¼šè‡ªåŠ¨è§£é”ï¼‰
    // lock1.unlock();
    // lock2.unlock();
}

int main() {
    SharedData account1(100);
    SharedData account2(50);
    
    std::thread t1(transfer, std::ref(account1), std::ref(account2), 10);
    std::thread t2(transfer, std::ref(account2), std::ref(account1), 5);
    
    t1.join();
    t2.join();
    
    return 0;
}
```

## ğŸ“Œ 4. lock_guard vs unique_lock è¯¦ç»†å¯¹æ¯”

### 4.1 åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | lock_guard | unique_lock |
|------|------------|-------------|
| è‡ªåŠ¨é”å®šè§£é” | âœ… | âœ… |
| æ‰‹åŠ¨é”å®šè§£é” | âŒ | âœ… |
| å»¶è¿Ÿé”å®š | âŒ | âœ… |
| å¯ç§»åŠ¨ | âŒ | âœ… |
| å¯å¤åˆ¶ | âŒ | âŒ |
| æ¡ä»¶å˜é‡æ”¯æŒ | âŒ | âœ… |
| try_lock æ”¯æŒ | âŒ | âœ… |
| è¶…æ—¶é”å®š | âŒ | âœ… |
| é”çŠ¶æ€æŸ¥è¯¢ | âŒ | âœ… |
| æ€§èƒ½å¼€é”€ | ä½ | è¾ƒé«˜ |
| å®ç°å¤æ‚åº¦ | ç®€å• | å¤æ‚ |

### 4.2 æ€§èƒ½å¯¹æ¯”

- **lock_guard**ï¼šå®ç°ç®€å•ï¼Œ**æ€§èƒ½å¼€é”€å°**ï¼Œå› ä¸ºå®ƒä¸éœ€è¦ç»´æŠ¤é¢å¤–çš„çŠ¶æ€ä¿¡æ¯
- **unique_lock**ï¼šå®ç°å¤æ‚ï¼Œ**æ€§èƒ½å¼€é”€è¾ƒå¤§**ï¼Œå› ä¸ºå®ƒéœ€è¦ç»´æŠ¤é”çš„çŠ¶æ€ä¿¡æ¯å’Œæ”¯æŒå¤šç§é”å®šæ¨¡å¼

### 4.3 é€‚ç”¨åœºæ™¯å¯¹æ¯”

| åœºæ™¯ | æ¨èä½¿ç”¨ | åŸå›  |
|------|----------|------|
| ç®€å•çš„ä¸´ç•ŒåŒºä¿æŠ¤ | lock_guard | ç®€å•ã€é«˜æ•ˆã€æ˜“è¯» |
| éœ€è¦æ‰‹åŠ¨æ§åˆ¶é”çš„ç”Ÿå‘½å‘¨æœŸ | unique_lock | æ”¯æŒæ‰‹åŠ¨é”å®š/è§£é” |
| éœ€è¦åœ¨å‡½æ•°é—´ä¼ é€’é” | unique_lock | æ”¯æŒç§»åŠ¨è¯­ä¹‰ |
| éœ€è¦ä¸æ¡ä»¶å˜é‡é…åˆ | unique_lock | æ¡ä»¶å˜é‡å¿…é¡»ä½¿ç”¨ unique_lock |
| éœ€è¦å°è¯•é”å®šæˆ–è¶…æ—¶é”å®š | unique_lock | æ”¯æŒ try_lock å’Œè¶…æ—¶é”å®š |
| éœ€è¦å»¶è¿Ÿé”å®š | unique_lock | æ”¯æŒ defer_lock å‚æ•° |
| éœ€è¦æŸ¥è¯¢é”çŠ¶æ€ | unique_lock | æ”¯æŒ owns_lock() æ–¹æ³• |

ğŸ’» **ä»£ç ç¤ºä¾‹ï¼šä¸¤ç§é”çš„å¯¹æ¯”ä½¿ç”¨**

```cpp
#include <thread>
#include <mutex>
#include <iostream>
#include <condition_variable>

std::mutex mutex;
std::condition_variable cv;
bool data_ready = false;
int shared_data = 0;

// ä½¿ç”¨ lock_guard çš„ç®€å•ä¸´ç•ŒåŒºä¿æŠ¤
void producer_with_lock_guard() {
    // lock_guard: ç®€å•é«˜æ•ˆ
    std::lock_guard<std::mutex> lock(mutex);
    shared_data = 42;
    data_ready = true;
    cv.notify_one();
}

// ä½¿ç”¨ unique_lock çš„å¤æ‚åœºæ™¯
void producer_with_unique_lock() {
    // unique_lock: çµæ´»å¯æ§
    std::unique_lock<std::mutex> lock(mutex);
    shared_data = 100;
    data_ready = true;
    
    // æ‰‹åŠ¨è§£é”ï¼Œå…è®¸æ¶ˆè´¹è€…æå‰è·å–é”
    lock.unlock();
    cv.notify_one();
    
    // å¯ä»¥å†æ¬¡é”å®š
    lock.lock();
    std::cout << "ç”Ÿäº§è€…å†æ¬¡è·å–é”" << std::endl;
}

// æ¶ˆè´¹è€…å¿…é¡»ä½¿ç”¨ unique_lockï¼ˆä¸æ¡ä»¶å˜é‡é…åˆï¼‰
void consumer() {
    std::unique_lock<std::mutex> lock(mutex);
    
    // ç­‰å¾…æ¡ä»¶æ»¡è¶³
    cv.wait(lock, []{ return data_ready; });
    
    std::cout << "æ¶ˆè´¹è€…è·å–åˆ°æ•°æ®: " << shared_data << std::endl;
    data_ready = false;
}

int main() {
    std::cout << "=== ä½¿ç”¨ lock_guard ===" << std::endl;
    std::thread t1(producer_with_lock_guard);
    std::thread t2(consumer);
    t1.join();
    t2.join();
    
    std::cout << "\n=== ä½¿ç”¨ unique_lock ===" << std::endl;
    std::thread t3(producer_with_unique_lock);
    std::thread t4(consumer);
    t3.join();
    t4.join();
    
    return 0;
}
```

**è¾“å‡ºç»“æœ**ï¼š
```cpp
=== ä½¿ç”¨ lock_guard ===
æ¶ˆè´¹è€…è·å–åˆ°æ•°æ®: 42

=== ä½¿ç”¨ unique_lock ===
æ¶ˆè´¹è€…è·å–åˆ°æ•°æ®: 100
ç”Ÿäº§è€…å†æ¬¡è·å–é”
```

ğŸ“‹ **æ€»ç»“ä¸æœ€ä½³å®è·µ**

## ğŸ“Œ 1. é€‰æ‹©åŸåˆ™

- **ä¼˜å…ˆä½¿ç”¨ lock_guard**ï¼šå¯¹äºç®€å•çš„ä¸´ç•ŒåŒºä¿æŠ¤ï¼Œlock_guard æ˜¯é¦–é€‰ï¼Œå®ƒç®€å•ã€é«˜æ•ˆã€æ˜“è¯»
- **ä»…åœ¨éœ€è¦æ—¶ä½¿ç”¨ unique_lock**ï¼šå½“éœ€è¦æ›´çµæ´»çš„é”æ§åˆ¶æ—¶ï¼Œæ‰è€ƒè™‘ä½¿ç”¨ unique_lock

## ğŸ“Œ 2. æœ€ä½³å®è·µ

1. **ä¿æŒé”çš„ä½œç”¨åŸŸæœ€å°**ï¼šå°½é‡ç¼©å°é”çš„ä¿æŠ¤èŒƒå›´ï¼Œå‡å°‘çº¿ç¨‹é˜»å¡æ—¶é—´
2. **é¿å…åµŒå¥—é”**ï¼šåµŒå¥—é”å®¹æ˜“å¯¼è‡´æ­»é”ï¼Œå°½é‡è®¾è®¡æ— é”ä¾èµ–çš„ä»£ç ç»“æ„
3. **ä½¿ç”¨ std::lock é¿å…æ­»é”**ï¼šå½“éœ€è¦é”å®šå¤šä¸ªäº’æ–¥é‡æ—¶ï¼Œä½¿ç”¨ `std::lock()` å‡½æ•°åŒæ—¶é”å®š
4. **é¿å…åœ¨æŒæœ‰é”æ—¶è°ƒç”¨å¤–éƒ¨å‡½æ•°**ï¼šé˜²æ­¢å¤–éƒ¨å‡½æ•°ä¸­å†æ¬¡è·å–åŒä¸€ä¸ªé”ï¼Œå¯¼è‡´æ­»é”
5. **ä½¿ç”¨ unique_lock é…åˆæ¡ä»¶å˜é‡**ï¼šæ¡ä»¶å˜é‡å¿…é¡»ä½¿ç”¨ unique_lock
6. **è€ƒè™‘ä½¿ç”¨ shared_mutex è¿›è¡Œè¯»å†™åˆ†ç¦»**ï¼šå¯¹äºè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œå¯ä»¥ä½¿ç”¨è¯»å†™é”æé«˜å¹¶å‘æ€§èƒ½

## ğŸ“Œ 3. å¸¸è§è¯¯åŒº

- **è¯¯åŒº1**ï¼šè®¤ä¸º unique_lock æ€»æ˜¯æ¯” lock_guard å¥½
  - å®é™…ä¸Šï¼Œå¯¹äºç®€å•åœºæ™¯ï¼Œlock_guard æ›´é«˜æ•ˆã€æ›´æ˜“è¯»
  - unique_lock çš„çµæ´»æ€§å¸¦æ¥äº†é¢å¤–çš„æ€§èƒ½å¼€é”€

- **è¯¯åŒº2**ï¼šæ‰‹åŠ¨ç®¡ç†é”æ¯”ä½¿ç”¨ RAII ç±»æ›´é«˜æ•ˆ
  - æ‰‹åŠ¨ç®¡ç†é”å®¹æ˜“å¿˜è®°è§£é”ï¼Œå¯¼è‡´æ­»é”
  - RAII ç±»ç¡®ä¿åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼ˆåŒ…æ‹¬å¼‚å¸¸ï¼‰éƒ½ä¼šæ­£ç¡®è§£é”

- **è¯¯åŒº3**ï¼šé”å¯ä»¥è§£å†³æ‰€æœ‰å¹¶å‘é—®é¢˜
  - é”åªæ˜¯åŒæ­¥æœºåˆ¶ä¹‹ä¸€ï¼Œè¿˜æœ‰åŸå­æ“ä½œã€æ— é”æ•°æ®ç»“æ„ç­‰å…¶ä»–æ–¹æ¡ˆ
  - è¿‡åº¦ä½¿ç”¨é”ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Œåº”è¯¥æ ¹æ®å…·ä½“æƒ…å†µé€‰æ‹©åˆé€‚çš„åŒæ­¥æœºåˆ¶

## ğŸ“Œ 4. æ€§èƒ½ä¼˜åŒ–å»ºè®®

- å¯¹äºé¢‘ç¹è®¿é—®çš„ä¸´ç•ŒåŒºï¼Œä¼˜å…ˆä½¿ç”¨ lock_guard
- å¯¹äºé”ç«äº‰æ¿€çƒˆçš„åœºæ™¯ï¼Œè€ƒè™‘ä½¿ç”¨æ›´ç»†ç²’åº¦çš„é”
- å¯¹äºè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œè€ƒè™‘ä½¿ç”¨ shared_mutex
- é¿å…åœ¨æŒæœ‰é”æ—¶æ‰§è¡Œè€—æ—¶æ“ä½œ
- è€ƒè™‘ä½¿ç”¨æ— é”æ•°æ®ç»“æ„æˆ–åŸå­æ“ä½œæ›¿ä»£é”

é€šè¿‡ç†è§£ lock_guard å’Œ unique_lock çš„åŒºåˆ«å’Œé€‚ç”¨åœºæ™¯ï¼Œå¯ä»¥åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­é€‰æ‹©åˆé€‚çš„é”æœºåˆ¶ï¼Œæ—¢ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œåˆèƒ½è·å¾—è¾ƒå¥½çš„æ€§èƒ½ã€‚è®°ä½ï¼š**ç®€å•çš„åœºæ™¯ç”¨ç®€å•çš„å·¥å…·ï¼Œå¤æ‚çš„åœºæ™¯ç”¨å¤æ‚çš„å·¥å…·**ã€‚