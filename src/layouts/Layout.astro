---
import FancyboxManager from "@components/effects/FancyboxManager.astro";
import FontManager from "@components/interactive/FontManager.astro";
import ConfigCarrier from "@components/layout/ConfigCarrier.astro";
import LoadingSpinner from "@components/LoadingSpinner.astro";
import ErrorBoundary from "@components/ErrorBoundary.astro";
import ErrorMessage from "@components/ErrorMessage.astro";

import { expressiveCodeConfig, profileConfig, siteConfig } from "@/config";
import {
	BANNER_HEIGHT,
	BANNER_HEIGHT_EXTEND,
	BANNER_HEIGHT_HOME,
	PAGE_WIDTH,
} from "@/constants/constants";
import { defaultFavicons } from "@/constants/icon";
import type { Favicon } from "@/types/config";
import {
	isHomePage as checkIsHomePage,
	getDefaultBackground,
} from "@/utils/layout-utils";
import { url } from "@/utils/url-utils";
import "katex/dist/katex.css";
import "@/styles/main.css";
import "@/styles/widget-responsive.css";
import "@/styles/navbar.css";
import "@/styles/fancybox-custom.css";
import "@/styles/layout-styles.css";
import "@/styles/waves.css";
import "@/styles/transition.css";
import { logger } from "@/utils/logger";

interface Props {
	title?: string;
	banner?: string;
	description?: string;
	lang?: string;
	setOGTypeArticle?: boolean;
	postSlug?: string;
	isHomePage?: boolean;
	enableBanner?: boolean;
	isWallpaperSwitchable?: boolean;
}

let {
	title,
	banner,
	description,
	lang,
	setOGTypeArticle,
	postSlug,
	isHomePage,
	enableBanner: enableBannerProp,
	isWallpaperSwitchable: isWallpaperSwitchableProp,
} = Astro.props;

// 判断当前页面类型
const isArticlePage = Boolean(postSlug || setOGTypeArticle);

// apply a class to the body element to decide the height of the banner, only used for initial page load
// Swup can update the body for each page visit, but it's after the page transition, causing a delay for banner height change
// so use Swup hooks instead to change the height immediately when a link is clicked
const isHomePageCheck = isHomePage ?? checkIsHomePage(Astro.url.pathname);

// defines global css variables
// why doing this in Layout instead of GlobalStyles: https://github.com/withastro/astro/issues/6728#issuecomment-1502203757
const configHue = siteConfig.themeColor.hue;

// 导航栏透明模式已被禁用，直接设置为不显示顶部高光效果
const shouldShowTopHighlight = false;

// 移除服务端设置 banner 的逻辑，改为在客户端动态设置

const enableBanner =
	enableBannerProp ?? siteConfig.backgroundWallpaper.mode === "banner";

let pageTitle: string;
if (title) {
	pageTitle = `${title} - ${siteConfig.title}`;
} else {
	pageTitle = siteConfig.subtitle
		? `${siteConfig.title} - ${siteConfig.subtitle}`
		: siteConfig.title;
}

let ogImageUrl: string | undefined;
if (siteConfig.generateOgImages && postSlug) {
	ogImageUrl = new URL(`/og/${postSlug}.png`, Astro.site).toString();
}

const favicons: Favicon[] =
	siteConfig.favicon.length > 0 ? siteConfig.favicon : defaultFavicons;

// const siteLang = siteConfig.lang.replace('_', '-')
if (!lang) {
	lang = `${siteConfig.lang}`;
}
const siteLang = lang.replace("_", "-");

// 使用固定的banner偏移量，position配置用于图片定位
const bannerOffset = `${BANNER_HEIGHT_EXTEND / 2}vh`;
---

<!doctype html>
<html lang={siteLang} class="bg-[var(--page-bg)] text-[14px] md:text-[16px]">
  <head>
    <!-- Google Tag Manager -->
    <script is:inline data-swup-ignore-script>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, "script", "dataLayer", "GTM-P53R3M9S");
    </script>
    <!-- End Google Tag Manager -->
    <!-- Microsoft Clarity -->
    <script is:inline data-swup-ignore-script type="text/javascript">
      (function (c, l, a, r, i, t, y) {
        c[a] =
          c[a] ||
          function () {
            (c[a].q = c[a].q || []).push(arguments);
          };
        t = l.createElement(r);
        t.async = 1;
        t.src = "https://www.clarity.ms/tag/" + i;
        y = l.getElementsByTagName(r)[0];
        y.parentNode.insertBefore(t, y);
      })(window, document, "clarity", "script", "tx9equrgr6");
    </script>
    <!-- End Microsoft Clarity -->

    <title>{pageTitle}</title>

    <!-- 资源预连接和 DNS 预取 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://www.googletagmanager.com">
    <link rel="preconnect" href="https://www.clarity.ms">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">
    <link rel="dns-prefetch" href="https://www.googletagmanager.com">
    <link rel="dns-prefetch" href="https://www.clarity.ms">

    <!-- Google Fonts - Inter & JetBrains Mono -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"></noscript>

    <meta charset="UTF-8" />
    <meta
      name="description"
      content={description || siteConfig.description || pageTitle}
    />
    {
      siteConfig.keywords && siteConfig.keywords.length > 0 && (
        <meta name="keywords" content={siteConfig.keywords.join(", ")} />
      )
    }
    <meta name="author" content={profileConfig.name} />

    <meta property="og:site_name" content={siteConfig.title} />
    <meta property="og:url" content={Astro.url} />
    <meta property="og:title" content={pageTitle} />
    <meta
      property="og:description"
      content={description || siteConfig.description || pageTitle}
    />
    <meta property="og:type" content={isArticlePage ? "article" : "website"} />

    <meta name="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={Astro.url} />
    <meta name="twitter:title" content={pageTitle} />
    <meta
      name="twitter:description"
      content={description || siteConfig.description || pageTitle}
    />

    <!-- 只在文章页面显示特色图片 -->
    {isArticlePage && ogImageUrl && <meta property="og:image" content={ogImageUrl} />}

    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <meta name="theme-color" content="#F1F5F9" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#0F172A" media="(prefers-color-scheme: dark)" />

    <!-- 关键图片资源预加载 -->
    <link rel="preload" href="/assets/images/logo.webp" as="image" type="image/webp" fetchpriority="high" />
    <link rel="preload" href="/assets/images/avatar.webp" as="image" type="image/webp" fetchpriority="high" />
    <link rel="preload" href="/assets/images/banner-light.webp" as="image" type="image/webp" media="(prefers-color-scheme: light)" fetchpriority="high" />
    <link rel="preload" href="/assets/images/banner-dark.webp" as="image" type="image/webp" media="(prefers-color-scheme: dark)" fetchpriority="high" />
    
    <!-- 预连接常用资源域名 -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <link rel="preconnect" href="https://unpkg.com" />
    {
      favicons.map((favicon) => (
        <link
          rel="icon"
          href={favicon.src.startsWith("/") ? url(favicon.src) : favicon.src}
          sizes={favicon.sizes}
          media={favicon.theme && `(prefers-color-scheme: ${favicon.theme})`}
        />
      ))
    }

    <!-- Set the theme before the page is rendered to avoid a flash -->
    <script
      is:inline
      define:vars={{
        BANNER_HEIGHT_EXTEND,
        PAGE_WIDTH,
        configHue,
        defaultMode: siteConfig.themeColor.defaultMode ?? "light",
        defaultWallpaperMode: siteConfig.backgroundWallpaper.mode,
        isWallpaperSwitchable:
          isWallpaperSwitchableProp ?? siteConfig.backgroundWallpaper.switchable ?? true,
        darkTheme: expressiveCodeConfig.darkTheme,
        lightTheme: expressiveCodeConfig.lightTheme,
        backgroundWallpaperSrc: siteConfig.backgroundWallpaper.src,
      }}
    >
      // 主题初始化 - 与setting-utils.ts保持一致
      const LIGHT_MODE = "light";
      const DARK_MODE = "dark";
      const SYSTEM_MODE = "system";

      // 获取存储的主题，如果没有则使用默认值
      const theme = localStorage.getItem("theme") || defaultMode;

      // 获取系统主题
      function getSystemTheme() {
        if (typeof window === "undefined") {
          return LIGHT_MODE;
        }
        return window.matchMedia("(prefers-color-scheme: dark)").matches
          ? DARK_MODE
          : LIGHT_MODE;
      }

      // 解析主题（如果是system模式，则获取系统主题）
      function resolveTheme(themeValue) {
        if (themeValue === SYSTEM_MODE) {
          return getSystemTheme();
        }
        return themeValue;
      }

      const resolvedTheme = resolveTheme(theme);
      const isDark = resolvedTheme === DARK_MODE;

      // 应用主题
      if (isDark) {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }

      // Set the theme for Expressive Code
      document.documentElement.setAttribute(
        "data-theme",
        isDark ? darkTheme : lightTheme
      );

      // 根据主题设置正确的背景图片
      (function setThemeBackground() {
        // 检查是否在浏览器环境中
        if (typeof window === "undefined" || typeof document === "undefined") {
          return;
        }

        // 获取背景图片配置
        const bgSrc = backgroundWallpaperSrc;

        // 选择与当前主题匹配的背景图片
        function getThemeBackground() {
          if (typeof bgSrc === "object" && bgSrc !== null && !Array.isArray(bgSrc)) {
            // 处理对象形式的配置
            const desktopSrc = bgSrc.desktop;
            const mobileSrc = bgSrc.mobile;
            
            // 获取当前设备类型
            const isMobile = window.innerWidth < 1024;
            const srcToUse = isMobile ? mobileSrc : desktopSrc;
            
            if (Array.isArray(srcToUse) && srcToUse.length > 1) {
              // 如果是数组，根据主题选择
              return isDark ? srcToUse[1] : srcToUse[0];
            } else if (typeof srcToUse === "string") {
              // 如果是字符串，直接使用
              return srcToUse;
            }
          } else if (typeof bgSrc === "string") {
            // 如果是字符串，直接使用
            return bgSrc;
          }
          return "";
        }

        // 设置背景图片
        const backgroundImage = getThemeBackground();
        if (backgroundImage) {
          // 找到banner元素并设置背景图片
          const banner = document.getElementById("banner");
          if (banner) {
            banner.style.backgroundImage = `url(${backgroundImage})`;
          }
        }
      })();

      // Load the hue from local storage
      const hue = localStorage.getItem("hue") || configHue;
      document.documentElement.style.setProperty("--hue", hue);

      // calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
      // 使用更准确的窗口高度计算
      function calculateBannerHeightExtend() {
        if (typeof window === "undefined") {
          return;
        }
        let offset = Math.floor(
          window.innerHeight * (BANNER_HEIGHT_EXTEND / 100)
        );
        offset = offset - (offset % 4);
        document.documentElement.style.setProperty(
          "--banner-height-extend",
          `${offset}px`
        );
      }

      // 立即设置初始值
      calculateBannerHeightExtend();

      // 在下一帧重新计算精确值（仅在值变化时更新，避免闪烁）
      if (typeof requestAnimationFrame !== "undefined") {
        requestAnimationFrame(() => {
          const oldValue = parseInt(
            document.documentElement.style.getPropertyValue(
              "--banner-height-extend"
            )
          );
          calculateBannerHeightExtend();
          const newValue = parseInt(
            document.documentElement.style.getPropertyValue(
              "--banner-height-extend"
            )
          );
          // 如果值变化了，再更新一次确保准确
          if (Math.abs(oldValue - newValue) > 4) {
            // 如果有明显变化，延迟一帧再更新，避免闪烁
            requestAnimationFrame(calculateBannerHeightExtend);
          }
        });
      }

      // 初始化壁纸模式 - 在页面渲染前应用
      const WALLPAPER_BANNER = "banner";
      const WALLPAPER_OVERLAY = "overlay";
      const WALLPAPER_NONE = "none";
      const wallpaperMode = isWallpaperSwitchable
        ? localStorage.getItem("wallpaperMode") || defaultWallpaperMode
        : defaultWallpaperMode;

      // 设置data-wallpaper-mode属性
      document.documentElement.setAttribute(
        "data-wallpaper-mode",
        wallpaperMode
      );

      // 立即执行函数来处理DOM
      (function applyWallpaperMode() {
        // 检查是否在浏览器环境中
        if (typeof window === "undefined" || typeof document === "undefined") {
          return;
        }
        
        // 尝试应用壁纸模式，如果DOM未准备好则重试
        function tryApply() {
          // 必须等到body存在
          if (!document.body) {
            requestAnimationFrame(tryApply);
            return;
          }

          // 根据模式隐藏显示对应元素
          if (
            wallpaperMode === WALLPAPER_NONE ||
            wallpaperMode === WALLPAPER_OVERLAY
          ) {
            // 隐藏横幅
            if (document.body) {
              document.body.classList.remove("enable-banner");
              document.body.classList.add("no-banner-layout");
            }
          } else {
            if (document.body) {
              document.body.classList.add("enable-banner");
              document.body.classList.remove("no-banner-layout");
            }
          }

          // 全屏壁纸模式
          if (wallpaperMode === WALLPAPER_OVERLAY) {
            if (document.body) {
              document.body.classList.add("wallpaper-transparent");
            }
          } else {
            if (document.body) {
              document.body.classList.remove("wallpaper-transparent");
            }
          }

          // 处理banner和fullscreen wallpaper的显示
          const bannerWrapper = document.getElementById("banner-wrapper");
          
          // 如果bannerWrapper还不存在（可能在body中但解析器还未到达），继续等待
          // 注意：bannerWrapper 是主要目标，如果它不存在，我们必须重试，否则它将保持 display: none
          if (!bannerWrapper && wallpaperMode !== WALLPAPER_NONE && wallpaperMode !== WALLPAPER_OVERLAY) {
             requestAnimationFrame(tryApply);
             return;
          }

          const fullscreenWallpaper = document.querySelector(
            "[data-fullscreen-wallpaper]"
          );

          // 根据主题更新背景图片
          function updateBackgroundImage() {
            const bgSrc = backgroundWallpaperSrc;
            
            function getThemeBackground() {
              if (typeof bgSrc === "object" && bgSrc !== null && !Array.isArray(bgSrc)) {
                const desktopSrc = bgSrc.desktop;
                const mobileSrc = bgSrc.mobile;
                const isMobile = window.innerWidth < 1024;
                const srcToUse = isMobile ? mobileSrc : desktopSrc;
                
                if (Array.isArray(srcToUse) && srcToUse.length > 1) {
                  return isDark ? srcToUse[1] : srcToUse[0];
                } else if (typeof srcToUse === "string") {
                  return srcToUse;
                }
              } else if (typeof bgSrc === "string") {
                return bgSrc;
              }
              return "";
            }

            const backgroundImage = getThemeBackground();
            if (backgroundImage && bannerWrapper) {
              const banner = bannerWrapper.querySelector("#banner");
              if (banner) {
                banner.style.backgroundImage = `url(${backgroundImage})`;
              }
            }
          }

          // 调用更新背景图片函数
          updateBackgroundImage();

          // 检查当前是否为首页
          const isHomePage =
            window.location.pathname === "/" || window.location.pathname === "";

          if (wallpaperMode === WALLPAPER_OVERLAY) {
            // 全屏壁纸模式：显示全屏壁纸，隐藏banner
            if (bannerWrapper) {
              bannerWrapper.style.display = "none";
            }
            if (fullscreenWallpaper) {
              fullscreenWallpaper.style.display = "block";
              fullscreenWallpaper.classList.remove("hidden", "opacity-0");
              fullscreenWallpaper.classList.add("opacity-100");
            }
          } else if (wallpaperMode === WALLPAPER_NONE) {
            // 纯色背景：隐藏所有壁纸
            if (bannerWrapper) {
              bannerWrapper.style.display = "none";
            }
            if (fullscreenWallpaper) {
              fullscreenWallpaper.style.display = "none";
              fullscreenWallpaper.classList.add("hidden", "opacity-0");
            }
          } else {
            // banner模式：显示banner，隐藏全屏壁纸
            if (bannerWrapper) {
              const isMobile = window.innerWidth < 1024;
              // 移动端非首页时隐藏banner（初始状态直接隐藏，不需要动画）
              // 桌面端始终显示banner
              if (isMobile && !isHomePage) {
                bannerWrapper.style.display = "none";
                bannerWrapper.classList.add("mobile-hide-banner");
              } else {
                bannerWrapper.style.display = "block";
                bannerWrapper.classList.remove("mobile-hide-banner");
              }
            }
            if (fullscreenWallpaper) {
              fullscreenWallpaper.style.display = "none";
              fullscreenWallpaper.classList.add("hidden", "opacity-0");
            }
          }

          // 处理主内容区域位置
          const mainContentWrapper = document.querySelector(
            ".absolute.w-full.z-30"
          );
          if (mainContentWrapper) {
            const isMobile = window.innerWidth < 1024;
            // 只在移动端非首页时调整主内容位置
            if (isMobile && !isHomePage) {
              mainContentWrapper.classList.add("mobile-main-no-banner");
            } else {
              mainContentWrapper.classList.remove("mobile-main-no-banner");
            }
          }

          // 处理credit元素
          const creditDesktop = document.getElementById(
            "banner-credit-desktop"
          );
          const creditMobile = document.getElementById("banner-credit-mobile");
          if (
            wallpaperMode === WALLPAPER_OVERLAY ||
            wallpaperMode === WALLPAPER_NONE
          ) {
            if (creditDesktop) creditDesktop.style.display = "none";
            if (creditMobile) creditMobile.style.display = "none";
          } else {
            if (creditDesktop) creditDesktop.style.display = "";
            if (creditMobile) creditMobile.style.display = "";
          }

          // 处理banner homeText元素
          const bannerTextOverlay = document.querySelector(
            ".banner-text-overlay"
          );
          if (bannerTextOverlay) {
            const isHomePage =
              window.location.pathname === "/" ||
              window.location.pathname === "";
            if (wallpaperMode === WALLPAPER_BANNER && isHomePage) {
              bannerTextOverlay.classList.remove("hidden");
            } else {
              bannerTextOverlay.classList.add("hidden");
            }
          }
        }

        // 启动尝试
        requestAnimationFrame(tryApply);
      })();

      // 高效图片预加载和懒加载功能
      (function initImageOptimization() {
        // 检查是否在浏览器环境中
        if (typeof window === "undefined" || typeof document === "undefined") {
          return;
        }

        // 需要预加载的关键图片列表
        const criticalImages = [
          "/assets/images/logo.webp",
          "/assets/images/avatar.webp",
          "/assets/images/banner-light.webp",
          "/assets/images/banner-dark.webp"
        ];

        // 图片加载状态管理
        const imageLoadStatus = {
          loaded: new Set(),
          failed: new Set(),
          loading: new Set()
        };

        // 预加载单个图片
        function preloadImage(src) {
          return new Promise((resolve, reject) => {
            // 检查图片是否已经在加载或已加载
            if (imageLoadStatus.loaded.has(src) || imageLoadStatus.loading.has(src)) {
              resolve(src);
              return;
            }
            
            const img = new Image();
            
            // 添加到加载中列表
            imageLoadStatus.loading.add(src);
            
            img.onload = function() {
              // 从加载中列表移除，添加到已加载列表
              imageLoadStatus.loading.delete(src);
              imageLoadStatus.loaded.add(src);
              resolve(src);
            };
            
            img.onerror = function() {
              // 从加载中列表移除，添加到加载失败列表
              imageLoadStatus.loading.delete(src);
              imageLoadStatus.failed.add(src);
              reject(src);
            };
            
            img.src = src;
          });
        }

        // 批量预加载关键图片
        async function preloadCriticalImages() {
          console.log("开始预加载关键图片...");
          
          // 并行加载关键图片，限制并发数以避免阻塞
          const concurrencyLimit = 2;
          const results = [];
          
          for (let i = 0; i < criticalImages.length; i += concurrencyLimit) {
            const batch = criticalImages.slice(i, i + concurrencyLimit);
            const batchPromises = batch.map(src => preloadImage(src));
            const batchResults = await Promise.allSettled(batchPromises);
            results.push(...batchResults);
            
            // 短暂延迟以避免过度占用资源
            if (i + concurrencyLimit < criticalImages.length) {
              await new Promise(resolve => setTimeout(resolve, 10));
            }
          }
          
          const successCount = results.filter(result => result.status === "fulfilled").length;
          const failureCount = results.filter(result => result.status === "rejected").length;
          
          console.log(`关键图片预加载完成: ${successCount} 成功, ${failureCount} 失败`);
          console.log(`已加载: ${imageLoadStatus.loaded.size} 张关键图片`);
          
          if (failureCount > 0) {
            console.warn(`加载失败的关键图片: ${Array.from(imageLoadStatus.failed).join(", ")}`);
          }
        }

        // 懒加载非关键图片
        function initLazyLoading() {
          // 使用 Intersection Observer 实现高效的懒加载
          const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                const img = entry.target;
                
                // 检查是否有 data-src 属性（懒加载属性）
                if (img.dataset.src) {
                  // 创建临时图片对象用于预加载
                  const tempImg = new Image();
                  
                  tempImg.onload = () => {
                    // 替换原始图片的 src
                    img.src = tempImg.src;
                    
                    // 添加淡入效果
                    img.style.opacity = 0;
                    img.style.transition = 'opacity 0.3s ease-in-out';
                    
                    // 短暂延迟后显示图片
                    requestAnimationFrame(() => {
                      img.style.opacity = 1;
                      
                      // 移除懒加载属性，添加已加载类
                      img.removeAttribute('data-src');
                      img.classList.add('lazy-loaded');
                      
                      // 触发自定义事件
                      img.dispatchEvent(new CustomEvent('lazy-loaded', { 
                        bubbles: true,
                        detail: { src: img.src }
                      }));
                    });
                  };
                  
                  tempImg.onerror = () => {
                    // 如果加载失败，添加错误类
                    img.classList.add('lazy-error');
                    img.alt = img.alt || '图片加载失败';
                    
                    // 触发错误事件
                    img.dispatchEvent(new CustomEvent('lazy-error', { 
                      bubbles: true,
                      detail: { src: img.dataset.src }
                    }));
                  };
                  
                  // 开始加载图片
                  tempImg.src = img.dataset.src;
                }
                
                // 停止观察已处理的图片
                observer.unobserve(img);
              }
            });
          }, {
            rootMargin: '100px' // 提前 100px 开始加载
          });

          // 观察所有带有 data-src 属性的图片
          document.querySelectorAll('img[data-src]').forEach(img => {
            imageObserver.observe(img);
          });
        }

        // 为图片添加加载状态管理
        function addImageLoadListeners() {
          // 监听页面中的图片加载
          document.addEventListener('DOMContentLoaded', function() {
            const images = document.querySelectorAll('img:not([data-src])'); // 排除懒加载的图片
            
            images.forEach(img => {
              // 检查图片是否已经加载完成
              if (img.complete) {
                // 图片已经加载完成，直接添加加载完成类
                img.classList.add('image-loaded');
              } else {
                // 图片还未加载完成，添加加载中类
                img.classList.add('image-loading');
                
                img.onload = function() {
                  // 移除加载中类，添加加载完成类
                  img.classList.remove('image-loading');
                  img.classList.add('image-loaded');
                  
                  // 触发加载完成事件
                  img.dispatchEvent(new CustomEvent('image-loaded', { 
                    bubbles: true,
                    detail: { src: img.src }
                  }));
                };
                
                img.onerror = function() {
                  // 移除加载中类，添加加载失败类
                  img.classList.remove('image-loading');
                  img.classList.add('image-error');
                  // 可以添加错误占位图
                  img.alt = img.alt || '图片加载失败';
                  
                  // 触发错误事件
                  img.dispatchEvent(new CustomEvent('image-error', { 
                    bubbles: true,
                    detail: { src: img.src }
                  }));
                };
              }
            });
          });
        }

        // 初始化所有图片优化功能
        preloadCriticalImages()
          .then(() => {
            // 关键图片预加载完成后，初始化懒加载
            initLazyLoading();
            addImageLoadListeners();
          })
          .catch(error => {
            console.error("关键图片预加载失败:", error);
            // 即使关键图片加载失败，也要初始化懒加载和其他功能
            initLazyLoading();
            addImageLoadListeners();
          });
      })();
    </script>
    <style
      define:vars={{
        configHue,
        "page-width": `${PAGE_WIDTH}rem`,
      }}
    ></style>
    <!-- defines global css variables. This will be applied to <html> <body> and some other elements idk why -->

    <slot name="head" />

    <link
      rel="alternate"
      type="application/rss+xml"
      title={profileConfig.name}
      href={`${Astro.site}rss.xml`}
    />


  </head>
  <body
    class="min-h-screen"
    class:list={[
      { "lg:is-home": isHomePageCheck, "enable-banner": enableBanner },
      ...(siteConfig.font.enable && siteConfig.font.selected
        ? (Array.isArray(siteConfig.font.selected)
            ? siteConfig.font.selected
            : [siteConfig.font.selected]
          ).map((fontId) => `font-${fontId}-enabled`)
        : []),
    ]}
  >
    <a href="#swup-container" class="skip-link">跳转到主要内容</a>
    <noscript
      ><iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-KRX3XGVH"
        height="0"
        width="0"
        style="display:none;visibility:hidden"></iframe></noscript
    >

    <!-- 页面顶部渐变高光效果 - 只在full和semifull模式下显示 -->
    {shouldShowTopHighlight && <div class="top-gradient-highlight" />}
    <!-- 背景容器 -->
    <div class="background-container">
        <div class="gradient-bg"></div>
        <div class="texture-bg"></div>
    </div>
    <ConfigCarrier />
    <FontManager />

    <ErrorBoundary>
      <slot />
    </ErrorBoundary>

    <!-- Loading Spinner -->
    <div id="page-loader" class="fixed inset-0 bg-white/80 dark:bg-gray-900/80 flex items-center justify-center z-50 hidden">
      <LoadingSpinner size="lg" />
    </div>

    <script>
      const showLoading = function() {
        const loader = document.getElementById('page-loader');
        if (loader) loader.classList.remove('hidden');
      };

      const hideLoading = function() {
        const loader = document.getElementById('page-loader');
        if (loader) loader.classList.add('hidden');
      };

      window.addEventListener('load', hideLoading);
      document.addEventListener('astro:page-load', showLoading);
      document.addEventListener('astro:page-load-complete', hideLoading);

      window.addEventListener('unhandledrejection', function(event) {
        console.error('未处理的 Promise 拒绝:', event.reason);
        const errorContainer = document.getElementById('error-boundary');
        if (errorContainer) {
          const message = event.reason?.message || '网络请求失败，请检查您的连接';
          const errorHtml = '<div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-6 text-center"><h3 class="text-lg font-semibold text-red-800 dark:text-red-200 mb-2">网络错误</h3><p class="text-red-600 dark:text-red-300 mb-4">' + message + '</p><button onclick="window.location.reload()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">重试</button></div>';
          errorContainer.innerHTML = errorHtml;
        }
      });
    </script>

    <!-- increase the page height during page transition to prevent the scrolling animation from jumping -->
    <div id="page-height-extend" class="hidden h-[300vh]"></div>



    <!-- Fancybox Manager - 只在文章详情页加载 -->
    {isArticlePage && <FancyboxManager />}
  </body>
</html>

<style
  is:global
  define:vars={{
    bannerOffset,
    "banner-height-home": `${BANNER_HEIGHT_HOME}vh`,
    "banner-height": `${BANNER_HEIGHT}vh`,
  }}
>
  @tailwind components;
  @layer components {
    .enable-banner.is-home #banner-wrapper {
      @apply h-[var(--banner-height-home)] translate-y-[var(--banner-height-extend)];
    }
    .enable-banner #banner-wrapper {
      @apply h-[var(--banner-height-home)];
    }

    .enable-banner.is-home #banner {
      @apply h-[var(--banner-height-home)] translate-y-0;
    }
    .enable-banner #banner {
      @apply h-[var(--banner-height-home)] translate-y-[var(--bannerOffset)];
    }
    .enable-banner.is-home #main-grid {
      @apply translate-y-[var(--banner-height-extend)];
    }
    .enable-banner #top-row {
      @apply h-[calc(var(--banner-height-home)_-_4.5rem)] transition-all duration-300;
    }
    .enable-banner.is-home #sidebar-sticky {
      @apply top-[calc(1rem_-_var(--banner-height-extend))];
    }
    .enable-banner.is-home #left-sidebar-sticky {
      @apply top-[calc(1rem_-_var(--banner-height-extend))];
    }

    .navbar-hidden {
      @apply opacity-0 -translate-y-16;
    }

    /* 图片加载状态样式 */
    img.image-loading {
      @apply opacity-100 transition-opacity duration-300;
    }

    img.image-loaded {
      @apply opacity-100 transition-opacity duration-300;
    }

    img.image-error {
      @apply opacity-100 bg-gray-100 dark:bg-gray-800;
    }
  }
</style>

<script>
  import "@/scripts/layout-script.ts";
</script>
