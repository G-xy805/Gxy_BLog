---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import PostCard from "@components/content/PostCard.astro";
import Icon from "@components/misc/Icon.astro";
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { getPostUrlBySlug } from "@utils/url-utils";
import type { GetStaticPaths } from "astro";
import Pagination from "@/components/common/controls/Pagination.astro";
import { siteConfig } from "@/config";

export async function getStaticPaths() {
	// 获取所有文章
	const allPosts = await getCollection("posts", ({ data }) => {
		return import.meta.env.PROD ? data.draft !== true : true;
	});

	// 提取所有唯一分类
	const categorySet = new Set<string>();
	allPosts.forEach((post) => {
		let category = post.data.category;
		if (!category) {
			category = i18n(I18nKey.uncategorized);
		}
		if (typeof category !== "string") {
			category = String(category);
		}
		category = category.trim();
		categorySet.add(category);
	});

	// 为每个分类生成路由
	const paths: any[] = [];

	for (const category of categorySet) {
		// ... existing logic to get categoryPosts ...
		const categoryPosts = allPosts
			.filter((post) => {
				let postCategory = post.data.category;
				if (!postCategory) {
					postCategory = i18n(I18nKey.uncategorized);
				}
				if (typeof postCategory !== "string") {
					postCategory = String(postCategory);
				}
				postCategory = postCategory.trim();
				return postCategory === category;
			})
			// ... sort logic ...
			.sort((a, b) => {
				if (a.data.pinned && !b.data.pinned) return -1;
				if (!a.data.pinned && b.data.pinned) return 1;
				const dateA = new Date(a.data.published);
				const dateB = new Date(b.data.published);
				if (dateA.getTime() !== dateB.getTime()) return dateA > dateB ? -1 : 1;
				const orderA =
					typeof a.data.order !== "undefined"
						? a.data.order
						: Number.MAX_SAFE_INTEGER;
				const orderB =
					typeof b.data.order !== "undefined"
						? b.data.order
						: Number.MAX_SAFE_INTEGER;
				return orderA - orderB;
			});

		const pageSize = siteConfig.pagination.postsPerPage;

		if (categoryPosts.length > pageSize) {
			const totalPages = Math.ceil(categoryPosts.length / pageSize);
			for (let pageNum = 2; pageNum <= totalPages; pageNum++) {
				const startIndex = (pageNum - 1) * pageSize;
				const endIndex = startIndex + pageSize;
				const pagePosts = categoryPosts.slice(startIndex, endIndex);

				// 原始路径
				paths.push({
					params: { slug: category, page: String(pageNum) },
					props: {
						page: {
							data: pagePosts,
							total: categoryPosts.length,
							size: pageSize,
							currentPage: pageNum,
							lastPage: totalPages,
							start: startIndex + 1,
							end: Math.min(endIndex, categoryPosts.length),
							url: {
								current: `/categories/${category}/${pageNum}/`,
								prev:
									pageNum > 2
										? `/categories/${category}/${pageNum - 1}/`
										: `/categories/${category}/`,
								next:
									pageNum < totalPages
										? `/categories/${category}/${pageNum + 1}/`
										: undefined,
								first: `/categories/${category}/`,
								last: `/categories/${category}/${totalPages}/`,
							},
						},
					},
				});

				// 如果分类名称包含特殊字符，也生成一个编码后的版本作为备份
				const encoded = encodeURIComponent(category);
				if (encoded !== category) {
					paths.push({
						params: { slug: encoded, page: String(pageNum) },
						props: {
							page: {
								data: pagePosts,
								total: categoryPosts.length,
								size: pageSize,
								currentPage: pageNum,
								lastPage: totalPages,
								start: startIndex + 1,
								end: Math.min(endIndex, categoryPosts.length),
								url: {
									current: `/categories/${encoded}/${pageNum}/`,
									prev:
										pageNum > 2
											? `/categories/${encoded}/${pageNum - 1}/`
											: `/categories/${encoded}/`,
									next:
										pageNum < totalPages
											? `/categories/${encoded}/${pageNum + 1}/`
											: undefined,
									first: `/categories/${encoded}/`,
									last: `/categories/${encoded}/${totalPages}/`,
								},
							},
						},
					});
				}
			}
		}
	}

	return paths;
}

// 获取当前分类和页码参数
const { slug } = Astro.params;
const decodedSlug = slug ? decodeURIComponent(slug) : "";

interface PageInfo {
	data: CollectionEntry<"posts">[];
	total: number;
	size: number;
	currentPage: number;
	lastPage: number;
	start: number;
	end: number;
	url: {
		current: string;
		prev: string | undefined;
		next: string | undefined;
		first: string | undefined;
		last: string | undefined;
	};
}
const { page } = Astro.props as { page: PageInfo };

// 页面标题
const pageTitle = `${i18n(I18nKey.categories)}: ${decodedSlug}`;
---

<MainGridLayout title={pageTitle}>
  <!-- 分类信息卡片 -->
  <div class="card-base mb-4 px-4 py-4 md:px-6 md:py-6">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 md:gap-6">
      <!-- 左侧信息 -->
      <div class="flex items-center gap-4 md:gap-6 w-full">
        <!-- 图标容器 -->
        <div class="flex items-center justify-center w-12 h-12 md:w-14 md:h-14 rounded-xl bg-[var(--primary)]/10 text-[var(--primary)] shrink-0">
          <Icon icon="ri:folder-5-fill" class="w-full h-full" />
        </div>
        
        <!-- 文字信息 -->
        <div class="flex flex-col justify-center min-w-0 flex-1">
          <div class="flex items-center gap-2 md:gap-3 flex-wrap">
              <h1 class="text-2xl md:text-3xl lg:text-4xl font-bold text-black/90 dark:text-white/90 leading-tight">{decodedSlug}</h1>
              <div class="gradient-badge text-xs md:text-sm px-2 py-0.5">
                  {page.total} {i18n(page.total === 1 ? I18nKey.postCount : I18nKey.postsCount)}
              </div>
          </div>
          <div class="text-xs text-black/50 dark:text-white/50 mt-1 md:mt-1.5">
              {i18n(I18nKey.browseAllPostsInCategory)}
          </div>
        </div>
      </div>

      <!-- 右侧按钮 -->
      <div class="w-full md:w-auto flex md:block">
        <a href="/categories/" class="w-full md:w-auto transition-all duration-300 flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg bg-[var(--primary)]/5 hover:bg-[var(--primary)]/10 text-[var(--primary)] group whitespace-nowrap text-sm md:text-base font-bold">
          <Icon icon="ri:list-check-2" class="w-5 h-5 shrink-0" />
          <span class="whitespace-nowrap">{i18n(I18nKey.allCategories)}</span>
        </a>
      </div>
    </div>
  </div>

  <!-- 文章列表 -->
  <div class="flex flex-col gap-4 mt-4">
    {page.data.length > 0 ? (
      page.data.map((post, index) => (
        <PostCard
          entry={post}
          title={post.data.title}
          url={getPostUrlBySlug(post.id)}
          published={post.data.published}
          image={post.data.image}
          description={post.data.description}
          style={`animation-delay: calc(var(--content-delay) + ${index * 50}ms);`}
          class:list={["onload-animation"]}
        />
      ))
    ) : (
      <div class="text-center py-12">
        <Icon icon="ri:empathize-line" class="mx-auto text-4xl text-gray-400 mb-4" />
        <p class="text-gray-600 dark:text-gray-300">{i18n(I18nKey.noPostsInCategory)}</p>
      </div>
    )}
  </div>

  <!-- 分页组件 -->
  {page.total > page.size && (
    <Pagination
      class="mx-auto onload-animation"
      page={page}
      style={`animation-delay: calc(var(--content-delay) + ${page.data.length * 50}ms)`}
    />
  )}
</MainGridLayout>

<script>
  // 响应式分页处理脚本
  document.addEventListener("DOMContentLoaded", function () {
    // 如果启用了响应式分页，添加相应的CSS类
    const responsiveEnabled = true; // ${siteConfig.pagination.responsive}
    if (responsiveEnabled) {
      const deviceType = getDeviceType();
      document.body.classList.add(`device-${deviceType}`);

      // 监听窗口大小变化
      let resizeTimeout;
      window.addEventListener("resize", function () {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function () {
          const newDeviceType = getDeviceType();
          const currentDeviceType = document.body.className.match(
            /device-(mobile|tablet|desktop)/
          )?.[1];

          if (currentDeviceType !== newDeviceType) {
            document.body.classList.remove(`device-${currentDeviceType}`);
            document.body.classList.add(`device-${newDeviceType}`);
          }
        }, 250);
      });
    }
  });

  function getDeviceType() {
    if (typeof window === "undefined") return "desktop";

    const width = window.innerWidth;
    if (width < 768) return "mobile";
    if (width < 1024) return "tablet";
    return "desktop";
  }
</script>

<style>
/* 确保分类卡片样式与首页一致 */
.onload-animation {
  animation: fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>
