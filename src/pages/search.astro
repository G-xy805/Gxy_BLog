---
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import MainGridLayout from "@/layouts/MainGridLayout.astro";
import Icon from "@components/misc/Icon.astro";
import { navBarSearchConfig } from "@/config";
import { NavBarSearchMethod } from "@/types/config";
import { url } from "@/utils/url-utils";
---

<MainGridLayout title={i18n(I18nKey.search)}>
  <div class="card-base mb-4">
    <div class="px-6 py-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div class="flex items-center gap-2">
          <Icon icon="feather:search" size="2xl" style="--dark-color: #93E7FB; color: #93E7FB;" />
          <h1 class="text-3xl font-bold text-[#394E6A] dark:text-[#F8F8F2]">{i18n(I18nKey.search)}</h1>
        </div>
        <a href="/" class="transition-all duration-300 inline-flex items-center justify-center gap-1 px-3 py-1.5 border border-[#394E6A] text-[#394E6A] text-sm font-bold rounded-lg hover:bg-[#394E6A] hover:text-white dark:border-white dark:text-white dark:hover:bg-white dark:hover:text-black">
          <Icon icon="feather:book-open" class="w-4 h-4" />
          <span class="mr-1">{i18n(I18nKey.backToBlog)}</span>
        </a>
      </div>
      <div class="divider my-6"></div>
      <div class="border-t border-[1.5px] border-[#EBEDF0] dark:border-[rgba(255,255,255,0.2)] mt-4 mb-6"></div>
      <div class="text-sm text-[#6B7A8F] dark:text-[#C5C5C3]">搜索博客的所有文章</div>
    </div>
  </div>
  <div class="card-base mt-4 search-panel">
    <div class="p-6 pb-4">
      <div class="flex transition-all items-center h-14 rounded-lg
            bg-black/[0.04] hover:bg-black/[0.06] focus-within:bg-black/[0.06]
            dark:bg-white/5 dark:hover:bg-white/10 dark:focus-within:bg-white/10
        ">
          <input placeholder="想搜点什么呢？"
                 class="transition-all pl-4 text-base bg-transparent outline-0
               h-full w-full text-black/50 dark:text-white/50"
          >
      </div>
      <div id="search-results" class="mt-2 max-h-[500px] overflow-y-auto"></div>
    </div>
  </div>

  <script>
    // 搜索功能实现
    let keyword = '';
    let result: { url: string; meta: { title: string }; excerpt: string }[] = [];
    let isSearching = false;
    let debounceTimer: ReturnType<typeof setTimeout>;

    // Mocks for Dev Mode
    const fakeResult = [
      {
        url: '/',
        meta: { title: '这是一个模拟搜索结果' },
        excerpt: '因为 Pagefind 无法在 <mark>开发</mark> 环境中工作。',
      },
      {
        url: '/',
        meta: { title: '如果你想测试搜索功能' },
        excerpt: '请尝试运行 <mark>npm build && npm preview</mark> 替代。',
      },
    ];

    // 搜索逻辑
    async function search() {
      if (!keyword) {
        result = [];
        updateResults();
        return;
      }

      isSearching = true;
      updateResults();

      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(async () => {
        try {
          let searchResults = [] as { url: string; meta: { title: string }; excerpt: string }[];

          if (import.meta.env.PROD && window.pagefind) {
            const response = await window.pagefind.search(keyword);
            searchResults = await Promise.all(
              response.results.map((item) => item.data()),
            );
          } else {
            // Dev mode with fake results
            searchResults = fakeResult;
          }

          result = searchResults;
        } catch (error) {
          console.error('Search error:', error);
          result = [];
        } finally {
          isSearching = false;
          updateResults();
        }
      }, 300); // 300ms debounce
    }

    // 更新搜索结果显示
    function updateResults() {
      const resultsContainer = document.getElementById('search-results');
      if (!resultsContainer) return;

      if (isSearching) {
        resultsContainer.innerHTML = '<div class="transition block rounded-xl text-lg px-3 py-2 text-50">正在搜索...</div>';
        return;
      }

      if (result.length > 0) {
        resultsContainer.innerHTML = result.map(item => `
          <a href="${item.url}" 
             class="transition first-of-type:mt-2 group block rounded-xl text-lg px-3 py-2 hover:bg-[var(--btn-plain-bg-hover)] active:bg-[var(--btn-plain-bg-active)]">
            <div class="transition text-90 inline-flex font-bold group-hover:text-[var(--primary)]">
              ${item.meta.title}
            </div>
            ${item.excerpt.includes('<mark>') ? `
              <div class="transition text-sm text-50" style="margin-top: 0.1rem">
                <div>
                  ${item.excerpt}
                </div>
              </div>
            ` : ''}
          </a>
        `).join('');
      } else if (keyword) {
        resultsContainer.innerHTML = '<div class="transition block rounded-xl text-lg px-3 py-2 text-50">找不到相关结果。</div>';
      } else {
        resultsContainer.innerHTML = '';
      }
    }

    // 初始化函数 - 添加事件监听器
    function initialize() {
      // 先移除所有旧的事件监听器（避免重复）
      const searchInput = document.querySelector('input[placeholder="想搜点什么呢？"]');
      if (searchInput) {
        // 克隆元素以移除所有事件监听器
        const newSearchInput = searchInput.cloneNode(true) as HTMLInputElement;
        const parentNode = searchInput.parentNode;
        if (parentNode) {
          parentNode.replaceChild(newSearchInput, searchInput);
          
          // 添加新的事件监听器
          newSearchInput.addEventListener('input', (e) => {
            const target = e.target as HTMLInputElement;
            keyword = target.value;
            search();
          });
        }
      }
    }

    // 页面加载完成后初始化
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initialize);
    } else {
      initialize();
    }
    
    // 监听页面可见性变化，当页面变为可见时重新初始化
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        initialize();
      }
    });
    
    // 监听历史记录变化，当使用客户端路由时重新初始化
    window.addEventListener('popstate', initialize);
    
    // 监听自定义事件，用于客户端路由切换
    document.addEventListener('astro:page-load', initialize);
    
    // 监听pushstate和replacestate事件
    const originalPushState = history.pushState;
    const originalReplaceState = history.replaceState;
    
    history.pushState = function(...args) {
      const result = originalPushState.apply(this, args);
      initialize();
      return result;
    };
    
    history.replaceState = function(...args) {
      const result = originalReplaceState.apply(this, args);
      initialize();
      return result;
    };
  </script>

  {navBarSearchConfig.method === NavBarSearchMethod.PageFind && import.meta.env.PROD && (
    <script is:inline define:vars={{ scriptUrl: url('/pagefind/pagefind.js') }}>
      async function loadPagefind() {
        try {
          const response = await fetch(scriptUrl, { method: 'HEAD' });
          if (!response.ok) {
            throw new Error(`Pagefind script not found: ${response.status}`);
          }
          const pagefind = await import(scriptUrl);
          await pagefind.options({
            excerptLength: 20
          });
          window.pagefind = pagefind;
          document.dispatchEvent(new CustomEvent('pagefindready'));
        } catch (error) {
          window.pagefind = {
            search: () => Promise.resolve({ results: [] }),
            options: () => Promise.resolve(),
          };
          document.dispatchEvent(new CustomEvent('pagefindloaderror'));
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadPagefind);
      } else {
        loadPagefind();
      }
    </script>
  )}
</MainGridLayout>

