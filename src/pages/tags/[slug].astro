---
import { getCollection } from "astro:content";
import PostCard from "@components/content/PostCard.astro";
import Icon from "@components/misc/Icon.astro";
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { getPostUrlBySlug } from "@utils/url-utils";

// 获取所有标签列表
export async function getStaticPaths() {
	const allPosts = await getCollection("posts", ({ data }) => {
		return import.meta.env.PROD ? data.draft !== true : true;
	});

	// 提取所有唯一标签
	const tagMap = new Map<string, number>();
	allPosts.forEach((post) => {
		if (post.data.tags && Array.isArray(post.data.tags)) {
			post.data.tags.forEach((tag) => {
				const t = typeof tag === "string" ? tag : String(tag);
				const tt = t.trim();
				if (tt) {
					tagMap.set(tt, (tagMap.get(tt) || 0) + 1);
				}
			});
		}
	});

	// 转换为路由参数
	return Array.from(tagMap.entries()).map(([name, count]) => ({
		params: { slug: name },
		props: { tagName: name, postCount: count },
	}));
}

// 获取当前标签的参数和属性
const { slug } = Astro.params;
const { tagName, postCount } = Astro.props;

// 获取当前标签下的所有文章
const tagPosts = await getCollection("posts", ({ data }) => {
	const isVisible = import.meta.env.PROD ? data.draft !== true : true;
	if (!data.tags || !Array.isArray(data.tags)) {
		return false;
	}
	return (
		isVisible &&
		data.tags.some((tag) => {
			const t = typeof tag === "string" ? tag : String(tag);
			return t.trim() === slug;
		})
	);
});

// 按发布日期排序（最新的在前）
tagPosts.sort(
	(a, b) =>
		new Date(b.data.published).getTime() - new Date(a.data.published).getTime(),
);

// 页面标题
const pageTitle = `${i18n(I18nKey.tags)}: ${tagName}`;
---

<MainGridLayout title={pageTitle}>
  <!-- 标签信息卡片 -->
  <div class="card-base mb-4 px-6 py-6">
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
      <!-- 左侧信息 -->
      <div class="flex items-center gap-4 w-full md:w-auto">
        <!-- 图标容器 -->
        <div class="flex items-center justify-center w-14 h-14 rounded-2xl bg-[var(--primary)]/10 text-[var(--primary)]">
          <Icon icon="ri:price-tag-3-line" class="w-8 h-8" />
        </div>
        
        <!-- 文字信息 -->
        <div class="flex flex-col">
          <div class="flex items-center gap-3">
              <h1 class="text-2xl font-bold text-black/90 dark:text-white/90">{tagName}</h1>
              <div class="badge rounded-md bg-[var(--primary)] text-white dark:text-black/90 text-xs px-2 py-0.5 border-none">
                  {postCount} {i18n(postCount === 1 ? I18nKey.postCount : I18nKey.postsCount)}
              </div>
          </div>
          <div class="text-sm text-black/50 dark:text-white/50 mt-1">
              {i18n(I18nKey.browseAllPostsInTag)}
          </div>
        </div>
      </div>

      <!-- 右侧按钮 -->
      <a href="/tags/" class="w-full md:w-auto transition-all duration-300 flex items-center justify-center gap-2 px-4 py-2 rounded-xl bg-[var(--primary)]/5 hover:bg-[var(--primary)]/10 text-[var(--primary)] group">
        <Icon icon="ri:list-check-2" class="w-5 h-5" />
        <span class="text-sm font-bold">{i18n(I18nKey.allTags)}</span>
      </a>
    </div>
  </div>

  <!-- 文章列表 -->
  <div class="flex flex-col gap-4 mt-4">
    {tagPosts.length > 0 ? (
      tagPosts.map((post, index) => (
        <PostCard
          entry={post}
          title={post.data.title}
          url={getPostUrlBySlug(post.id)}
          published={post.data.published}
          image={post.data.image}
          description={post.data.description}
          style={`animation-delay: calc(var(--content-delay) + ${index * 50}ms);`}
          class:list="onload-animation"
        />
      ))
    ) : (
      <div class="text-center py-12">
        <Icon icon="ri:empathize-line" class="mx-auto text-4xl text-gray-400 mb-4" />
        <p class="text-gray-600 dark:text-gray-300">{i18n(I18nKey.noPostsInTag)}</p>
      </div>
    )}
  </div>
</MainGridLayout>

<style>
/* 确保标签卡片样式与首页一致 */
.onload-animation {
  animation: fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>
